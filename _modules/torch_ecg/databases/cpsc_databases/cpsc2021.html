
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch_ecg.databases.cpsc_databases.cpsc2021 &#8212; torch-ecg 0.0.31 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=97348ffd" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=97348ffd" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../_static/documentation_options.js?v=c5dbc6bb"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/torch_ecg/databases/cpsc_databases/cpsc2021';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.0.31" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/deep-psp-logo.png" class="logo__image only-light" alt=""/>
    <img src="../../../../_static/deep-psp-logo.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">torch-ecg</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tutorial.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../CHANGELOG.html">
    Changelog
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DeepPSP/torch_ecg" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tutorial.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../CHANGELOG.html">
    Changelog
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DeepPSP/torch_ecg" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch_ecg.databases.cpsc_databases.cpsc2021</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for torch_ecg.databases.cpsc_databases.cpsc2021</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Real</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wfdb</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">...cfg</span><span class="w"> </span><span class="kn">import</span> <span class="n">CFG</span><span class="p">,</span> <span class="n">DEFAULTS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_docstring</span><span class="p">,</span> <span class="n">get_record_list_recursive3</span><span class="p">,</span> <span class="n">ms2samples</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.utils_interval</span><span class="w"> </span><span class="kn">import</span> <span class="n">generalized_intervals_intersection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_FIG_SIZE_PER_SEC</span><span class="p">,</span> <span class="n">DataBaseInfo</span><span class="p">,</span> <span class="n">PhysioNetDataBase</span><span class="p">,</span> <span class="n">WFDB_Beat_Annotations</span><span class="p">,</span> <span class="n">_PlotCfg</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CPSC2021&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_metrics&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_CPSC2021_INFO</span> <span class="o">=</span> <span class="n">DataBaseInfo</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    The 4th China Physiological Signal Challenge 2021:</span>
<span class="s2">    Paroxysmal Atrial Fibrillation Events Detection from Dynamic ECG Recordings</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">about</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    1. source ECG data are recorded from 12-lead Holter or 3-lead wearable ECG monitoring devices</span>
<span class="s2">    2. dataset provides variable-length ECG fragments extracted from lead I and lead II of the long-term source ECG data, each sampled at 200 Hz</span>
<span class="s2">    3. AF event is limited to be no less than 5 heart beats</span>
<span class="s2">    4. training set in the 1st stage consists of 730 records, extracted from the Holter records from 12 AF patients and 42 non-AF patients (usually including other abnormal and normal rhythms); training set in the 2nd stage consists of 706 records from 37 AF patients (18 PAF patients) and 14 non-AF patients</span>
<span class="s2">    5. test set comprises data from the same source as the training set as well as DIFFERENT data source, which are **NOT** to be released at any point</span>
<span class="s2">    6. annotations are standardized according to PhysioBank Annotations (Ref. [2]_ or :meth:`PhysioNetDataBase.helper`), and include the beat annotations (R peak location and beat type), the rhythm annotations (rhythm change flag and rhythm type) and the diagnosis of the global rhythm</span>
<span class="s2">    7. classification of a record is stored in corresponding .hea file, which can be accessed via the attribute `comments` of a wfdb Record obtained using :func:`wfdb.rdheader`, :func:`wfdb.rdrecord`, and :func:`wfdb.rdsamp`; beat annotations and rhythm annotations can be accessed using the attributes `symbol`, `aux_note` of a ``wfdb`` Annotation obtained using :func:`wfdb.rdann`, corresponding indices in the signal can be accessed via the attribute `sample`</span>
<span class="s2">    8. challenge task:</span>

<span class="s2">        - clasification of rhythm types: non-AF rhythm (N), persistent AF rhythm (AFf) and paroxysmal AF rhythm (AFp)</span>
<span class="s2">        - locating of the onset and offset for any AF episode prediction</span>

<span class="s2">    9. challenge metrics:</span>

<span class="s2">        - metrics (Ur, scoring matrix) for classification:</span>

<span class="s2">          .. tikz:: The scoring matrix for the recording-level classification result.</span>
<span class="s2">            :align: center</span>
<span class="s2">            :libs: positioning</span>

<span class="s2">            \tikzstyle</span><span class="si">{rect}</span><span class="s2"> = [rectangle, text width = 50, text centered, inner sep = 3pt, minimum height = 50]</span>
<span class="s2">            \tikzstyle</span><span class="si">{txt}</span><span class="s2"> = [rectangle, text centered, inner sep = 3pt, minimum height = 1.5]</span>

<span class="s2">            \node[rect, fill = green!25] at (0,0) (31) {$-0.5$};</span>
<span class="s2">            \node[rect, fill = green!10, right = 0 of 31] (32) {$0$};</span>
<span class="s2">            \node[rect, fill = red!30, right = 0 of 32] (33) {$+1$};</span>
<span class="s2">            \node[rect, fill = green!40, above = 0 of 31] (21) {$-1$};</span>
<span class="s2">            \node[rect, fill = red!30, above = 0 of 32] (22) {$+1$};</span>
<span class="s2">            \node[rect, fill = green!10, above = 0 of 33] (23) {$0$};</span>
<span class="s2">            \node[rect, fill = red!30, above = 0 of 21] (11) {$+1$};</span>
<span class="s2">            \node[rect, fill = green!60, above = 0 of 22] (12) {$-2$};</span>
<span class="s2">            \node[rect, fill = green!40, above = 0 of 23] (13) {$-1$};</span>

<span class="s2">            \node[txt, below = 0 of 31] </span><span class="si">{N}</span><span class="s2">;</span>
<span class="s2">            \node[txt, below = 0 of 32] (anchor_h) {AF$_{\text</span><span class="si">{f}</span><span class="s2">}$};</span>
<span class="s2">            \node[txt, below = 0 of 33] {AF$_{\text</span><span class="si">{p}</span><span class="s2">}$};</span>
<span class="s2">            \node[txt, left = 0 of 31] {AF$_{\text</span><span class="si">{p}</span><span class="s2">}$};</span>
<span class="s2">            \node[txt, left = 0 of 21] (anchor_v) {AF$_{\text</span><span class="si">{f}</span><span class="s2">}$};</span>
<span class="s2">            \node[txt, left = 0 of 11] </span><span class="si">{N}</span><span class="s2">;</span>

<span class="s2">            \node[txt, below = 0 of anchor_h] {\large\textbf{Annotation (Label)}};</span>
<span class="s2">            \node[txt, left = 0.6 of anchor_v, rotate = 90, anchor = north] {\large\textbf</span><span class="si">{Prediction}</span><span class="s2">};</span>

<span class="s2">        - metric (Ue) for detecting onsets and offsets for AF events (episodes): +1 if the detected onset (or offset) is within ±1 beat of the annotated position, and +0.5 if within ±2 beats.</span>
<span class="s2">        - final score (U):</span>

<span class="s2">          .. math::</span>

<span class="s2">            U = \dfrac</span><span class="si">{1}{N}</span><span class="s2"> \sum\limits_{i=1}^N \left( Ur_i + \dfrac</span><span class="si">{Ma_i}</span><span class="s2">{\max\{Mr_i, Ma_i\}} \right)</span>

<span class="s2">          where :math:`N` is the number of records,</span>
<span class="s2">          :math:`Ma` is the number of annotated AF episodes,</span>
<span class="s2">          :math:`Mr` is the number of predicted AF episodes.</span>

<span class="s2">    10. Challenge official website [1]_. Webpage of the database on PhysioNet [2]_.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    1. if an ECG record is classified as AFf, the provided onset and offset locations should be the first and last record points. If an ECG record is classified as N, the answer should be an empty list</span>
<span class="s2">    2. it can be inferred from the classification scoring matrix that the punishment of false negatives of AFf is very heavy, while mixing-up of AFf and AFp is not punished</span>
<span class="s2">    3. flag of atrial fibrillation and atrial flutter (&quot;AFIB&quot; and &quot;AFL&quot;) in annotated information are seemed as the same type when scoring the method</span>
<span class="s2">    4. the 3 classes can coexist in ONE subject (not one record). For example, subject 61 has 6 records with label &quot;N&quot;, 1 with label &quot;AFp&quot;, and 2 with label &quot;AFf&quot;</span>
<span class="s2">    5. rhythm change annotations (&quot;(AFIB&quot;, &quot;(AFL&quot;, &quot;(N&quot; in the `aux_note` field or &quot;+&quot; in the `symbol` field of the annotation files) are inserted 0.15s ahead of or behind (onsets or offset resp.) of corresponding R peaks.</span>
<span class="s2">    6. some records are revised if there are heart beats of the AF episode or the pause between adjacent AF episodes less than 5. The id numbers of the revised records are summarized in the attached `REVISED_RECORDS`.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">usage</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;AF (event, fine) detection&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">references</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;http://icbeb2021.pastconf.com/CPSC2021&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://www.physionet.org/content/cpsc2021/&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">doi</span><span class="o">=</span><span class="s2">&quot;10.13026/ksya-qw89&quot;</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="CPSC2021">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021">[docs]</a>
<span class="nd">@add_docstring</span><span class="p">(</span><span class="n">_CPSC2021_INFO</span><span class="o">.</span><span class="n">format_database_docstring</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;prepend&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CPSC2021</span><span class="p">(</span><span class="n">PhysioNetDataBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db_dir : `path-like`, optional</span>
<span class="sd">        Storage path of the database.</span>
<span class="sd">        If not specified, data will be fetched from Physionet.</span>
<span class="sd">    working_dir : `path-like`, optional</span>
<span class="sd">        Working directory, to store intermediate files and log files.</span>
<span class="sd">    verbose : int, default 1</span>
<span class="sd">        Level of logging verbosity.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        Auxilliary key word arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;CPSC2021&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">db_name</span><span class="o">=</span><span class="s2">&quot;cpsc2021&quot;</span><span class="p">,</span>
            <span class="n">db_dir</span><span class="o">=</span><span class="n">db_dir</span><span class="p">,</span>
            <span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_dir_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;training_I&quot;</span><span class="p">,</span>
            <span class="s2">&quot;training_II&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span> <span class="o">=</span> <span class="s2">&quot;dat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span> <span class="o">=</span> <span class="s2">&quot;atr&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_ext</span> <span class="o">=</span> <span class="s2">&quot;hea&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_leads</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;II&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_patterns_with_ext</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^data_(?:</span><span class="se">\\</span><span class="s2">d+)_(?:</span><span class="se">\\</span><span class="s2">d+)</span><span class="se">\\</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span><span class="si">}</span><span class="s2">$&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2a</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># fullname to abbreviation</span>
            <span class="s2">&quot;non atrial fibrillation&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
            <span class="s2">&quot;paroxysmal atrial fibrillation&quot;</span><span class="p">:</span> <span class="s2">&quot;AFp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;persistent atrial fibrillation&quot;</span><span class="p">:</span> <span class="s2">&quot;AFf&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2n</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># fullname to number</span>
            <span class="s2">&quot;non atrial fibrillation&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;paroxysmal atrial fibrillation&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;persistent atrial fibrillation&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nb_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="s2">&quot;training_I&quot;</span><span class="p">:</span> <span class="mi">730</span><span class="p">,</span> <span class="s2">&quot;training_II&quot;</span><span class="p">:</span> <span class="mi">706</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__revised_records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_subjects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;record&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tranche&quot;</span><span class="p">,</span>
            <span class="s2">&quot;subject_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;record_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sig_len&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sig_len_sec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;revised&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ls_rec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_stats</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ls_diagnoses_records</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="mf">1e-7</span>  <span class="c1"># dealing with round(0.5) = 0, hence keeping accordance with output length of `resample_poly`</span>

        <span class="c1"># self.palette = {&quot;spb&quot;: &quot;yellow&quot;, &quot;pvc&quot;: &quot;red&quot;,}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ls_rec</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ls_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all records in the database directory</span>
<span class="sd">        and store them (path, metadata, etc.) in some private attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_record_list_recursive3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_dir_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_patterns_with_ext</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;tranche&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;training_I&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">53</span> <span class="k">else</span> <span class="s2">&quot;training_II&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">),</span>
                <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)))),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;subsample `</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">` records from `</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">SEED</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;tranche&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subject_id</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">t</span><span class="p">]])),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subject_records</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
                <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subject_id</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="o">==</span> <span class="n">sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="p">[</span><span class="n">t</span><span class="p">]}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">l_r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">l_r</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">l_s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l_s</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate stats on the whole dataset.&quot;&quot;&quot;</span>
        <span class="n">stats_file</span> <span class="o">=</span> <span class="s2">&quot;stats.csv&quot;</span>
        <span class="n">stats_file_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir_base</span> <span class="o">/</span> <span class="n">stats_file</span>
        <span class="k">if</span> <span class="n">stats_file_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">stats_file_fp</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats_columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Please wait patiently to let the reader aggregate statistics on the whole dataset...&quot;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">])</span>  <span class="c1"># use self.all_records to ensure it&#39;s computed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;tranche&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records_inv</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_label</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;sig_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="o">.</span><span class="n">sig_len</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;sig_len_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;sig_len&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;revised&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__revised_records</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;record_id&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats_columns</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stats_file_fp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> seconds!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># currently no need to parse the loaded csv file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all_subjects</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subject_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CFG</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_records</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">df_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ls_diagnoses_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all the records for all diagnoses.&quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;diagnoses_records_list.json&quot;</span>
        <span class="n">dr_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir_base</span> <span class="o">/</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">dr_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dr_fp</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Please wait several minutes patiently to let the reader list records for each diagnosis...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2a</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_records</span><span class="p">:</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_label</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> seconds!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">][</span><span class="s2">&quot;record&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2a</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dr_fp</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diagnoses_records_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ls_diagnoses_records</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span>

<div class="viewcode-block" id="CPSC2021.get_subject_id">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.get_subject_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_subject_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach a unique subject ID to the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sid : str</span>
<span class="sd">            Subject ID corresponding to the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sid</span></div>


<div class="viewcode-block" id="CPSC2021.get_absolute_path">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.get_absolute_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">extension</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the absolute path of the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        extension : str, optional</span>
<span class="sd">            Extension of the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        abs_path : pathlib.Path</span>
<span class="sd">            Absolute path of the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">extension</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">abs_path</span> <span class="o">=</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">abs_path</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_samp_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate `sampfrom` and `sampto` so that they are reasonable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Start index of the data to be loaded.</span>
<span class="sd">        sampto : int, optional</span>
<span class="sd">            End index of the data to be loaded.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sf : int</span>
<span class="sd">            Index sampling from.</span>
<span class="sd">        st : int</span>
<span class="sd">            Index sampling to.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">sig_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="o">.</span><span class="n">record</span> <span class="o">==</span> <span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sig_len</span>
        <span class="n">sf</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sampfrom</span> <span class="k">if</span> <span class="n">sampfrom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">sampto</span><span class="p">,</span> <span class="n">sig_len</span><span class="p">)</span> <span class="k">if</span> <span class="n">sampto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sig_len</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sampto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sampto</span> <span class="o">&gt;</span> <span class="n">sig_len</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;the end index </span><span class="si">{</span><span class="n">sampto</span><span class="si">}</span><span class="s2"> is larger than the signal length </span><span class="si">{</span><span class="n">sig_len</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="sa">f</span><span class="s2">&quot;so it is set to </span><span class="si">{</span><span class="n">sig_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sf</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid `sampfrom` and `sampto`&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sf</span><span class="p">,</span> <span class="n">st</span>

<div class="viewcode-block" id="CPSC2021.load_ann">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.load_ann">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_ann</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;rpeaks&quot;</span><span class="p">,</span> <span class="s2">&quot;af_episodes&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load annotations of the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        field : {&quot;rpeaks&quot;, &quot;af_episodes&quot;, &quot;label&quot;, &quot;raw&quot;, &quot;wfdb&quot;}, optional</span>
<span class="sd">            Field of the annotation.</span>
<span class="sd">            If is None, all fields of the annotation will be returned in the form of a dict.</span>
<span class="sd">            If is &quot;raw&quot; or &quot;wfdb&quot;, then the corresponding wfdb &quot;Annotation&quot; will be returned.</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Start index of the annotation to be loaded.</span>
<span class="sd">        sampto: int, optional</span>
<span class="sd">            End index of the annotation to be loaded.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Key word arguments for functions</span>
<span class="sd">            loading rpeaks, af_episodes, and label respectively,</span>
<span class="sd">            including:</span>

<span class="sd">                - fs: int, optional,</span>
<span class="sd">                  the resampling frequency</span>
<span class="sd">                - fmt: str,</span>
<span class="sd">                  format of af_episodes, or format of label,</span>
<span class="sd">                  for more details, ref. corresponding functions.</span>

<span class="sd">            Used only when `field` is specified (not None).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ann : dict or list or numpy.ndarray or str</span>
<span class="sd">            Annotaton of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sf</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_samp_interval</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">sampfrom</span><span class="p">,</span> <span class="n">sampto</span><span class="p">)</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdann</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
            <span class="n">extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span><span class="p">,</span>
            <span class="n">sampfrom</span><span class="o">=</span><span class="n">sf</span><span class="p">,</span>
            <span class="n">sampto</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># `load_af_episodes` should not use sampfrom, sampto</span>
        <span class="n">func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rpeaks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_rpeaks</span><span class="p">,</span>
            <span class="s2">&quot;af_episodes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_af_episodes</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_label</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">ann</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;key word arguments `</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">` ignored when `field` is not specified!&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">ann</span>
        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ann</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid `field`: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">ann</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ann</span></div>


<div class="viewcode-block" id="CPSC2021.load_rpeaks">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.load_rpeaks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_rpeaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wfdb</span><span class="o">.</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Real</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load position (in terms of samples) of rpeaks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        ann : wfdb.Annotation, optional</span>
<span class="sd">            The wfdb Annotation of the record.</span>
<span class="sd">            If is None, corresponding annotation file will be read.</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Start index of the rpeak positions to be loaded.</span>
<span class="sd">        sampto : int, optional</span>
<span class="sd">            End index of the rpeak positions to be loaded.</span>
<span class="sd">        keep_original : bool, default False</span>
<span class="sd">            If True, indices will keep the same with the annotation file,</span>
<span class="sd">            otherwise subtract `sampfrom` if specified.</span>
<span class="sd">        valid_only : bool, default True</span>
<span class="sd">            If True, only valid rpeaks will be returned,</span>
<span class="sd">            otherwise, all indices in the `sample` field of the annotation will be returned.</span>
<span class="sd">            Valid rpeaks are those with symbol in `WFDB_Beat_Annotations`.</span>
<span class="sd">            Symbols in `WFDB_Non_Beat_Annotations` are considered as invalid rpeaks</span>
<span class="sd">        fs : numbers.Real, optional</span>
<span class="sd">            If not None, positions of the loaded rpeaks</span>
<span class="sd">            will be ajusted according to this sampling frequency.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rpeaks : numpy.ndarray</span>
<span class="sd">            Position (in terms of samples) of rpeaks of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sf</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_samp_interval</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">sampfrom</span><span class="p">,</span> <span class="n">sampto</span><span class="p">)</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdann</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
                <span class="n">extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span><span class="p">,</span>
                <span class="n">sampfrom</span><span class="o">=</span><span class="n">sf</span><span class="p">,</span>
                <span class="n">sampto</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">critical_points</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">symbol</span>
        <span class="k">if</span> <span class="n">sampfrom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keep_original</span><span class="p">:</span>
            <span class="n">critical_points</span> <span class="o">=</span> <span class="n">critical_points</span> <span class="o">-</span> <span class="n">sampfrom</span>
        <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">:</span>
            <span class="n">critical_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">critical_points</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
            <span class="n">rpeaks_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">WFDB_Beat_Annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">rpeaks</span> <span class="o">=</span> <span class="n">critical_points</span><span class="p">[</span><span class="n">rpeaks_valid</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rpeaks</span> <span class="o">=</span> <span class="n">critical_points</span>
        <span class="k">return</span> <span class="n">rpeaks</span></div>


<div class="viewcode-block" id="CPSC2021.load_rpeak_indices">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.load_rpeak_indices">[docs]</a>
    <span class="nd">@add_docstring</span><span class="p">(</span><span class="n">load_rpeaks</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_rpeak_indices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wfdb</span><span class="o">.</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Real</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alias of `self.load_rpeaks`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_rpeaks</span><span class="p">(</span>
            <span class="n">rec</span><span class="o">=</span><span class="n">rec</span><span class="p">,</span>
            <span class="n">ann</span><span class="o">=</span><span class="n">ann</span><span class="p">,</span>
            <span class="n">sampfrom</span><span class="o">=</span><span class="n">sampfrom</span><span class="p">,</span>
            <span class="n">sampto</span><span class="o">=</span><span class="n">sampto</span><span class="p">,</span>
            <span class="n">keep_original</span><span class="o">=</span><span class="n">keep_original</span><span class="p">,</span>
            <span class="n">valid_only</span><span class="o">=</span><span class="n">valid_only</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CPSC2021.load_af_episodes">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.load_af_episodes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_af_episodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wfdb</span><span class="o">.</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Real</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fmt</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;c_intervals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;intervals&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the episodes of atrial fibrillation,</span>
<span class="sd">        in terms of intervals or mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        ann : wfdb.Annotation, optional</span>
<span class="sd">            The wfdb Annotation of the record.</span>
<span class="sd">            If is None, corresponding annotation file will be read.</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Start index of the AF episodes to be loaded.</span>
<span class="sd">            Not used when `fmt` is &quot;c_intervals&quot;.</span>
<span class="sd">        sampto : int, optional</span>
<span class="sd">            End index of the AF episodes to be loaded.</span>
<span class="sd">            Not used when `fmt` is &quot;c_intervals&quot;.</span>
<span class="sd">        keep_original : bool, default False</span>
<span class="sd">            If True, indices will keep the same with the annotation file,</span>
<span class="sd">            otherwise subtract `sampfrom` if specified.</span>
<span class="sd">            Valid only when `fmt` is not &quot;c_intervals&quot;.</span>
<span class="sd">        fs : numbers.Real, optional</span>
<span class="sd">            If not None, positions of the loaded intervals</span>
<span class="sd">            or mask will be ajusted according to this sampling frequency.</span>
<span class="sd">            Otherwise, the sampling frequency of the record will be used.</span>
<span class="sd">        fmt : {&quot;intervals&quot;, &quot;mask&quot;, &quot;c_intervals&quot;}, optional</span>
<span class="sd">            Format of the episodes of atrial fibrillation, by default &quot;intervals&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        af_episodes : list or numpy.ndarray</span>
<span class="sd">            Episodes of atrial fibrillation, in terms of intervals or mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2a</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">siglen</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">sig_len</span>
        <span class="n">_ann</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdann</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span> <span class="n">extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span><span class="p">)</span>
        <span class="n">sf</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_samp_interval</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">sampfrom</span><span class="p">,</span> <span class="n">sampto</span><span class="p">)</span>
        <span class="n">aux_note</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_ann</span><span class="o">.</span><span class="n">aux_note</span><span class="p">)</span>
        <span class="n">critical_points</span> <span class="o">=</span> <span class="n">_ann</span><span class="o">.</span><span class="n">sample</span>
        <span class="n">af_start_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">aux_note</span> <span class="o">==</span> <span class="s2">&quot;(AFIB&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aux_note</span> <span class="o">==</span> <span class="s2">&quot;(AFL&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># ref. NOTE 3.</span>
        <span class="n">af_end_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_note</span> <span class="o">==</span> <span class="s2">&quot;(N&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">af_start_inds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">af_end_inds</span><span class="p">),</span> <span class="s2">&quot;unequal number of af period start indices and af period end indices&quot;</span>

        <span class="k">if</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;c_intervals&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">sf</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">st</span> <span class="o">&lt;</span> <span class="n">siglen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;when `fmt` is `c_intervals`, `sampfrom` and `sampto` should never be used!&quot;</span><span class="p">)</span>
            <span class="n">af_episodes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">af_start_inds</span><span class="p">,</span> <span class="n">af_end_inds</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">af_episodes</span>

        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">af_start_inds</span><span class="p">,</span> <span class="n">af_end_inds</span><span class="p">):</span>
            <span class="n">itv</span> <span class="o">=</span> <span class="p">[</span><span class="n">critical_points</span><span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="n">critical_points</span><span class="p">[</span><span class="n">end</span><span class="p">]]</span>
            <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">generalized_intervals_intersection</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="p">[[</span><span class="n">sf</span><span class="p">,</span> <span class="n">st</span><span class="p">]])</span>

        <span class="n">siglen</span> <span class="o">=</span> <span class="n">st</span> <span class="o">-</span> <span class="n">sf</span>
        <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">:</span>
            <span class="n">siglen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="n">siglen</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="n">sf</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;AFf&quot;</span><span class="p">:</span>
                <span class="c1"># ref. NOTE. 1 of the class docstring</span>
                <span class="c1"># the `ann.sample` does not always satify this point after resampling</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sf</span><span class="p">,</span> <span class="n">siglen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">intervals</span>
                <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_original</span><span class="p">:</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="p">[[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span><span class="p">]</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">af_episodes</span> <span class="o">=</span> <span class="n">intervals</span>

        <span class="k">if</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">siglen</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span> <span class="p">:</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">af_episodes</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">af_episodes</span></div>


<div class="viewcode-block" id="CPSC2021.load_label">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.load_label">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_label</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wfdb</span><span class="o">.</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load (classifying) label of the record.</span>

<span class="sd">        The three classes are:</span>

<span class="sd">            - &quot;non atrial fibrillation&quot;,</span>
<span class="sd">            - &quot;paroxysmal atrial fibrillation&quot;,</span>
<span class="sd">            - &quot;persistent atrial fibrillation&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        ann : wfdb.Annotation, optional</span>
<span class="sd">            Not used, to keep in accordance with other methods.</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Not used, to keep in accordance with other methods.</span>
<span class="sd">        sampto : int, optional</span>
<span class="sd">            Not used, to keep in accordance with other methods.</span>
<span class="sd">        fmt : str, default &quot;a&quot;</span>
<span class="sd">            Format of the label, case in-sensitive, can be one of</span>

<span class="sd">                - &quot;f&quot;, &quot;fullname&quot;: the full name of the label</span>
<span class="sd">                - &quot;a&quot;, &quot;abbr&quot;, &quot;abbrevation&quot;: abbreviation for the label</span>
<span class="sd">                - &quot;n&quot;, &quot;num&quot;, &quot;number&quot;: class number of the label</span>
<span class="sd">                  (in accordance with the settings of the offical class map)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        label : str</span>
<span class="sd">            Classifying label of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;abbr&quot;</span><span class="p">,</span> <span class="s2">&quot;abbreviation&quot;</span><span class="p">]:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2a</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_f2n</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;format `</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">` of labels is not supported!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span></div>


<div class="viewcode-block" id="CPSC2021.gen_endpoint_score_mask">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.gen_endpoint_score_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_endpoint_score_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">bias</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the scoring mask for the onsets and offsets of af episodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        bias : dict, default {1: 1, 2: 0.5}</span>
<span class="sd">            Bias for the scoring of the onsets and offsets of af episodes.</span>
<span class="sd">            Keys are bias (with ±) in terms of number of rpeaks, and</span>
<span class="sd">            values are corresponding scores.</span>
<span class="sd">        verbose : int, optional</span>
<span class="sd">            Verbosity level. If is None, :attr:`self.verbose` will be used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        onset_score_mask, offset_score_mask: Tuple[numpy.ndarray]</span>
<span class="sd">            2-tuple of :class:`~numpy.ndarray`, which are the</span>
<span class="sd">            scoring mask for the onset and offsets predictions of af episodes.</span>

<span class="sd">        NOTE</span>
<span class="sd">        ----</span>
<span class="sd">        The onsets in `af_intervals` are 0.15s ahead of the corresponding R peaks,</span>
<span class="sd">        while the offsets in `af_intervals` are 0.15s behind the corresponding R peaks.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">gen_endpoint_score_mask</span><span class="p">(</span>
            <span class="n">siglen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_stats</span><span class="o">.</span><span class="n">record</span> <span class="o">==</span> <span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sig_len</span><span class="p">,</span>
            <span class="n">critical_points</span><span class="o">=</span><span class="n">wfdb</span><span class="o">.</span><span class="n">rdann</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span> <span class="n">extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">af_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_af_episodes</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;c_intervals&quot;</span><span class="p">),</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">masks</span></div>


<div class="viewcode-block" id="CPSC2021.plot">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CPSC2021.html#torch_ecg.databases.CPSC2021.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ticks_granularity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">sampfrom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sampto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">leads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">waves</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the signals of a record.</span>

<span class="sd">        plot the signals of a record or external signals (units in μV),</span>
<span class="sd">        with metadata (labels, episodes of atrial fibrillation, etc.),</span>
<span class="sd">        possibly also along with wave delineations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        data : numpy.ndarray, optional</span>
<span class="sd">            (2-lead) ECG signal to plot.</span>
<span class="sd">            Should be of the format &quot;channel_first&quot;, and compatible with `leads`.</span>
<span class="sd">            If given, data of `rec` will not be used.</span>
<span class="sd">            This is useful when plotting filtered data.</span>
<span class="sd">        ann : dict, optional</span>
<span class="sd">            Annotations for `data`.</span>
<span class="sd">            Ignored if `data` is None.</span>
<span class="sd">        ticks_granularity : int, default 0</span>
<span class="sd">            Granularity to plot axis ticks, the higher the more ticks.</span>
<span class="sd">            0 (no ticks) --&gt; 1 (major ticks) --&gt; 2 (major + minor ticks)</span>
<span class="sd">        sampfrom : int, optional</span>
<span class="sd">            Start index of the data to plot.</span>
<span class="sd">        sampto : int, optional</span>
<span class="sd">            End index of the data to plot.</span>
<span class="sd">        leads : str or List[str], optional</span>
<span class="sd">            Names of the leads to plot.</span>
<span class="sd">        waves : dict, optional</span>
<span class="sd">            Indices of the wave critical points, including</span>
<span class="sd">            &quot;p_onsets&quot;, &quot;p_peaks&quot;, &quot;p_offsets&quot;,</span>
<span class="sd">            &quot;q_onsets&quot;, &quot;q_peaks&quot;, &quot;r_peaks&quot;, &quot;s_peaks&quot;, &quot;s_offsets&quot;,</span>
<span class="sd">            &quot;t_onsets&quot;, &quot;t_peaks&quot;, &quot;t_offsets&quot;</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments to pass to :func:`matplotlib.pyplot.plot`.</span>

<span class="sd">        TODO</span>
<span class="sd">        ----</span>
<span class="sd">        1. Slice too long records, and plot separately for each segment.</span>
<span class="sd">        2. Plot waves using :func:`~matplotlib.pyplot.axvspan`.</span>

<span class="sd">        NOTE</span>
<span class="sd">        ----</span>
<span class="sd">        1. `Locator` of ``plt`` has default `MAXTICKS` of 1000.</span>
<span class="sd">           If not modifying this number, at most 40 seconds of signal could be plotted once.</span>
<span class="sd">        2. Raw data usually have very severe baseline drifts,</span>
<span class="sd">           hence the isoelectric line is not plotted.</span>

<span class="sd">        Contributors: Jeethan, and WEN Hao</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;plt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="o">.</span><span class="n">MAXTICKS</span> <span class="o">=</span> <span class="mi">3000</span>

        <span class="n">_leads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_leads</span><span class="p">(</span><span class="n">leads</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                <span class="n">rec</span><span class="p">,</span>
                <span class="n">leads</span><span class="o">=</span><span class="n">_leads</span><span class="p">,</span>
                <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;channel_first&quot;</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;μV&quot;</span><span class="p">,</span>
                <span class="n">sampfrom</span><span class="o">=</span><span class="n">sampfrom</span><span class="p">,</span>
                <span class="n">sampto</span><span class="o">=</span><span class="n">sampto</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_infer_units</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input data is auto detected to have units in </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mv&quot;</span><span class="p">:</span>
                <span class="n">_data</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">assert</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">_leads</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;number of leads from data of shape (</span><span class="si">{</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) does not match the length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_leads</span><span class="p">)</span><span class="si">}</span><span class="s2">) of `leads`&quot;</span>

        <span class="n">sf</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">sampfrom</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">sampto</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_data</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">waves</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">p_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">p</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">p_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;q_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;s_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">q_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">s</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">s_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;q_peaks&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;s_peaks&quot;</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;r_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">qrs_radius</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">r</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">qrs_radius</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;r_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">t_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">t</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">t_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_waves</span><span class="p">,</span> <span class="n">qrs</span><span class="p">,</span> <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;p_waves&quot;</span><span class="p">:</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;qrs&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_waves&quot;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">plot_alpha</span> <span class="o">=</span> <span class="mf">0.4</span>

        <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">sampfrom</span><span class="o">=</span><span class="n">sampfrom</span><span class="p">,</span> <span class="n">sampto</span><span class="o">=</span><span class="n">sampto</span><span class="p">)</span>
            <span class="n">rpeaks</span> <span class="o">=</span> <span class="n">_ann</span><span class="p">[</span><span class="s2">&quot;rpeaks&quot;</span><span class="p">]</span>
            <span class="n">af_episodes</span> <span class="o">=</span> <span class="n">_ann</span><span class="p">[</span><span class="s2">&quot;af_episodes&quot;</span><span class="p">]</span>
            <span class="n">af_episodes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sf</span><span class="p">]</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">af_episodes</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">_ann</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rpeaks</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rpeaks&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">af_episodes</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;af_episodes&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">nb_leads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_leads</span><span class="p">)</span>

        <span class="n">line_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">*</span> <span class="mi">25</span>  <span class="c1"># 25 seconds</span>
        <span class="n">nb_lines</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">line_len</span><span class="p">)</span>

        <span class="n">bias_thr</span> <span class="o">=</span> <span class="mf">0.07</span>
        <span class="c1"># winL = 0.06</span>
        <span class="c1"># winR = 0.08</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_lines</span><span class="p">):</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span> <span class="p">:</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">]</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="p">(</span><span class="n">sf</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span>
            <span class="n">fig_sz_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DEFAULT_FIG_SIZE_PER_SEC</span> <span class="o">*</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">))</span>
            <span class="c1"># if same_range:</span>
            <span class="c1">#     y_ranges = np.ones((seg.shape[0],)) * np.max(np.abs(seg)) + 100</span>
            <span class="c1"># else:</span>
            <span class="c1">#     y_ranges = np.max(np.abs(seg), axis=1) + 100</span>
            <span class="c1"># fig_sz_h = 6 * y_ranges / 1500</span>
            <span class="n">fig_sz_h</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">([</span><span class="n">seg_lead</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">seg_lead</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">200</span> <span class="k">for</span> <span class="n">seg_lead</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1500</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nb_leads</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_sz_w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fig_sz_h</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">nb_leads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">ax_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_leads</span><span class="p">):</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lead - </span><span class="si">{</span><span class="n">_leads</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># axes[ax_idx].axhline(y=0, linestyle=&quot;-&quot;, linewidth=&quot;1.0&quot;, color=&quot;red&quot;)</span>
                <span class="c1"># NOTE that `Locator` has default `MAXTICKS` equal to 1000</span>
                <span class="k">if</span> <span class="n">ticks_granularity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ticks_granularity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.04</span><span class="p">))</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="c1"># add extra info. to legend</span>
                <span class="c1"># https://stackoverflow.com/questions/16826711/is-it-possible-to-add-a-string-as-a-legend-item-in-matplotlib</span>
                <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;label - </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">seg_rpeaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rpeaks</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">seg_rpeaks</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span> <span class="o">-</span> <span class="n">bias_thr</span><span class="p">),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">secs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span> <span class="o">+</span> <span class="n">bias_thr</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s2">&quot;qrs&quot;</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">seg_af_episodes</span> <span class="o">=</span> <span class="n">generalized_intervals_intersection</span><span class="p">(</span>
                    <span class="n">af_episodes</span><span class="p">,</span>
                    <span class="p">[[</span><span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">]],</span>
                <span class="p">)</span>
                <span class="n">seg_af_episodes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">]</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">seg_af_episodes</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">itv_start</span><span class="p">,</span> <span class="n">itv_end</span> <span class="ow">in</span> <span class="n">seg_af_episodes</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">secs</span><span class="p">[</span><span class="n">itv_start</span><span class="p">:</span><span class="n">itv_end</span><span class="p">],</span>
                        <span class="n">seg</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">,</span> <span class="n">itv_start</span><span class="p">:</span><span class="n">itv_end</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p_waves&quot;</span><span class="p">,</span> <span class="s2">&quot;qrs&quot;</span><span class="p">,</span> <span class="s2">&quot;t_waves&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                        <span class="n">itv_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">)</span>
                        <span class="n">itv_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">,</span> <span class="n">line_len</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">itv_start</span> <span class="o">&lt;</span> <span class="n">itv_end</span> <span class="o">&lt;=</span> <span class="n">line_len</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
                            <span class="n">secs</span><span class="p">[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">],</span>
                            <span class="n">secs</span><span class="p">[</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">line_len</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">w</span><span class="p">],</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="n">plot_alpha</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">secs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># axes[ax_idx].set_ylim(-y_ranges[ax_idx], y_ranges[ax_idx])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Voltage [μV]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        dealing with round(0.5) = 0,</span>
<span class="sd">        hence keeping accordance with output length of `resample_poly`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">url_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;URL of the compressed database file.</span>

<span class="sd">        .. versionadded:: 0.0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_compressed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_compressed</span>
        <span class="c1"># currently, cpsc2021 is not included in the list obtained</span>
        <span class="c1"># using `wfdb.get_dbs()`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url_compressed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;https://www.physionet.org/static/published-projects/cpsc2021/&quot;</span>
            <span class="s2">&quot;paroxysmal-atrial-fibrillation-events-detection-from-dynamic-ECG-recordings&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-the-4th-china-physiological-signal-challenge-2021-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.zip&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_compressed</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">database_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataBaseInfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_CPSC2021_INFO</span></div>



<span class="c1">###################################################################</span>
<span class="c1"># copied and modified from the official scoring code</span>
<span class="c1">###################################################################</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>  <span class="c1"># scoring matrix for classification</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RefInfo</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_path</span> <span class="o">=</span> <span class="n">sample_path</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">len_sig</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af_starts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af_ends</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_ref</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoints_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">af_starts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_ends</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># self.endpoints_true = np.concatenate((self.af_starts, self.af_ends), axis=-1)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onset_score_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset_score_range</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_endpoint_score_range</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onset_score_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_score_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sig</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdsamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_path</span><span class="p">)</span>
        <span class="n">ann_ref</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdann</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_path</span><span class="p">,</span> <span class="s2">&quot;atr&quot;</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">sample_descrip</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span>

        <span class="n">beat_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann_ref</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># r-peak locations</span>
        <span class="n">ann_note</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann_ref</span><span class="o">.</span><span class="n">aux_note</span><span class="p">)</span>  <span class="c1"># rhythm change flag</span>

        <span class="n">af_start_scripts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ann_note</span> <span class="o">==</span> <span class="s2">&quot;(AFIB&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ann_note</span> <span class="o">==</span> <span class="s2">&quot;(AFL&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">af_end_scripts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ann_note</span> <span class="o">==</span> <span class="s2">&quot;(N&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;non atrial fibrillation&quot;</span> <span class="ow">in</span> <span class="n">sample_descrip</span><span class="p">:</span>
            <span class="n">class_true</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="s2">&quot;persistent atrial fibrillation&quot;</span> <span class="ow">in</span> <span class="n">sample_descrip</span><span class="p">:</span>
            <span class="n">class_true</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="s2">&quot;paroxysmal atrial fibrillation&quot;</span> <span class="ow">in</span> <span class="n">sample_descrip</span><span class="p">:</span>
            <span class="n">class_true</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: the recording is out of range!&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">fs</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">beat_loc</span><span class="p">,</span> <span class="n">af_start_scripts</span><span class="p">,</span> <span class="n">af_end_scripts</span><span class="p">,</span> <span class="n">class_true</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_endpoint_score_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">onset_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">len_sig</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">offset_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">len_sig</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">af_start</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">af_starts</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">onset_range</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 1): 0 --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 1): 0 --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">max</span><span class="p">(</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">onset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">onset_range</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 0.5): 0 --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 0.5): 0 --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">onset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">onset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_start</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="n">onset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">onset_range</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 1): 0 --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 1): 0 --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">onset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- onset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_start</span><span class="o">+</span><span class="mi">3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;official --- onset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_start</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">af_end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">af_ends</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_sig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">len_sig</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">3</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 1): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 1): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- -1&quot;</span><span class="p">)</span>
                <span class="n">offset_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (c_ind, score 0.5): </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">3</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;official --- offset (sample, score 0.5): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beat_loc</span><span class="p">[</span><span class="n">af_end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">onset_range</span><span class="p">,</span> <span class="n">offset_range</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_ans</span><span class="p">(</span><span class="n">ans_file</span><span class="p">):</span>
    <span class="n">endpoints_pred</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ans_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ans_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">ans_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">endpoints_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ans_dic</span><span class="p">[</span><span class="s2">&quot;predict_endpoints&quot;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">ans_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mat&quot;</span><span class="p">):</span>
        <span class="n">ans_struct</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">ans_file</span><span class="p">)</span>
        <span class="n">endpoints_pred</span> <span class="o">=</span> <span class="n">ans_struct</span><span class="p">[</span><span class="s2">&quot;predict_endpoints&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">endpoints_pred</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ue_calculate</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">,</span> <span class="n">endpoints_true</span><span class="p">,</span> <span class="n">onset_score_range</span><span class="p">,</span> <span class="n">offset_score_range</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ma</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints_true</span><span class="p">)</span>
    <span class="n">mr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span> <span class="ow">in</span> <span class="n">endpoints_pred</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">onset_score_range</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)]</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">offset_score_range</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span>

    <span class="n">score</span> <span class="o">*=</span> <span class="n">ma</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">mr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">score</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ur_calculate</span><span class="p">(</span><span class="n">class_true</span><span class="p">,</span> <span class="n">class_pred</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">class_true</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">class_pred</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">score</span>


<span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">ans_path</span><span class="p">):</span>
    <span class="c1"># AF burden estimation</span>
    <span class="n">SCORE</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_mat_or_json</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mat&quot;</span><span class="p">))</span>

    <span class="n">ans_set</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">is_mat_or_json</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ans_path</span><span class="p">))</span>
    <span class="c1"># test_set = open(os.path.join(data_path, &#39;RECORDS&#39;), &#39;r&#39;).read().splitlines()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ans_sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ans_set</span><span class="p">):</span>
        <span class="n">sample_nam</span> <span class="o">=</span> <span class="n">ans_sample</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">sample_nam</span><span class="p">)</span>

        <span class="n">endpoints_pred</span> <span class="o">=</span> <span class="n">load_ans</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ans_path</span><span class="p">,</span> <span class="n">ans_sample</span><span class="p">))</span>
        <span class="n">TrueRef</span> <span class="o">=</span> <span class="n">RefInfo</span><span class="p">(</span><span class="n">sample_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">class_pred</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TrueRef</span><span class="o">.</span><span class="n">len_sig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">class_pred</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_pred</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ur_score</span> <span class="o">=</span> <span class="n">ur_calculate</span><span class="p">(</span><span class="n">TrueRef</span><span class="o">.</span><span class="n">class_true</span><span class="p">,</span> <span class="n">class_pred</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">TrueRef</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">TrueRef</span><span class="o">.</span><span class="n">class_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ue_score</span> <span class="o">=</span> <span class="n">ue_calculate</span><span class="p">(</span>
                <span class="n">endpoints_pred</span><span class="p">,</span>
                <span class="n">TrueRef</span><span class="o">.</span><span class="n">endpoints_true</span><span class="p">,</span>
                <span class="n">TrueRef</span><span class="o">.</span><span class="n">onset_score_range</span><span class="p">,</span>
                <span class="n">TrueRef</span><span class="o">.</span><span class="n">offset_score_range</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ue_score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">ur_score</span> <span class="o">+</span> <span class="n">ue_score</span>
        <span class="n">SCORE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

    <span class="n">score_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">SCORE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">score_avg</span>


<span class="c1">###################################################################</span>
<span class="c1"># custom metric computing function</span>
<span class="c1">###################################################################</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_challenge_metric</span><span class="p">(</span>
    <span class="n">class_true</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">class_pred</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">endpoints_true</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">endpoints_pred</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">onset_score_range</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">offset_score_range</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute challenge metric for a single record</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    class_true: int,</span>
<span class="sd">        labelled for the record</span>
<span class="sd">    class_pred: int,</span>
<span class="sd">        predicted class for the record</span>
<span class="sd">    endpoints_true: sequence of intervals,</span>
<span class="sd">        labelled intervals of AF episodes</span>
<span class="sd">    endpoints_pred: sequence of intervals,</span>
<span class="sd">        predicted intervals of AF episodes</span>
<span class="sd">    onset_score_range: sequence of float,</span>
<span class="sd">        scoring mask for the AF onset predictions</span>
<span class="sd">    offset_score_range: sequence of float,</span>
<span class="sd">        scoring mask for the AF offset predictions</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    u: float,</span>
<span class="sd">        the final score for the prediction</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ur_score</span> <span class="o">=</span> <span class="n">ur_calculate</span><span class="p">(</span><span class="n">class_true</span><span class="p">,</span> <span class="n">class_pred</span><span class="p">)</span>
    <span class="n">ue_score</span> <span class="o">=</span> <span class="n">ue_calculate</span><span class="p">(</span><span class="n">endpoints_pred</span><span class="p">,</span> <span class="n">endpoints_true</span><span class="p">,</span> <span class="n">onset_score_range</span><span class="p">,</span> <span class="n">offset_score_range</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ur_score</span> <span class="o">+</span> <span class="n">ue_score</span>
    <span class="k">return</span> <span class="n">u</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gen_endpoint_score_mask</span><span class="p">(</span>
    <span class="n">siglen</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">critical_points</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">af_intervals</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">bias</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generate the scoring mask for the onsets and offsets of af episodes,</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    siglen: int,</span>
<span class="sd">        length of the signal</span>
<span class="sd">    critical_points: sequence of int,</span>
<span class="sd">        locations (indices in the signal) of the critical points,</span>
<span class="sd">        including R peaks, rhythm annotations, etc,</span>
<span class="sd">        which are stored in the `sample` fields of an wfdb annotation file</span>
<span class="sd">        (corr. beat ann, rhythm ann are in the `symbol`, `aux_note` fields)</span>
<span class="sd">    af_intervals: sequence of intervals,</span>
<span class="sd">        intervals of the af episodes in terms of indices in `critical_points`</span>
<span class="sd">    bias: dict, default {1:1, 2:0.5},</span>
<span class="sd">        keys are bias (with ±) in terms of number of rpeaks</span>
<span class="sd">        values are corresponding scores</span>
<span class="sd">    verbose: int, default 0,</span>
<span class="sd">        log verbosity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (onset_score_mask, offset_score_mask): 2-tuple of ndarray,</span>
<span class="sd">        scoring mask for the onset and offsets predictions of af episodes</span>

<span class="sd">    NOTE</span>
<span class="sd">    ----</span>
<span class="sd">    1. the onsets in `af_intervals` are 0.15s ahead of the corresponding R peaks,</span>
<span class="sd">    while the offsets in `af_intervals` are 0.15s behind the corresponding R peaks.</span>
<span class="sd">    2. for records [data_39_4,data_48_4,data_68_23,data_98_5,data_101_5,data_101_7,data_101_8,data_104_25,data_104_27],</span>
<span class="sd">    the official `RefInfo._gen_endpoint_score_range` slightly expands the scoring intervals at heads or tails of the records,</span>
<span class="sd">    which strictly is incorrect as defined in the `Scoring` section of the official webpage (http://2021.icbeb.org/CPSC2021)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_critical_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">critical_points</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_critical_points</span><span class="p">:</span>
        <span class="n">_critical_points</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_af_intervals</span> <span class="o">=</span> <span class="p">[[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">af_intervals</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;0 added to _critical_points, len(_critical_points): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ==&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_af_intervals</span> <span class="o">=</span> <span class="p">[[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">af_intervals</span><span class="p">]</span>
    <span class="c1"># records with AFf mostly have `_critical_points` ending with `siglen-1`</span>
    <span class="c1"># but in some rare case ending with `siglen`</span>
    <span class="k">if</span> <span class="n">siglen</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">_critical_points</span><span class="p">:</span>
        <span class="n">_critical_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">siglen</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in _critical_points siglen-1 (=</span><span class="si">{</span><span class="n">siglen</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">) changed to siglen (=</span><span class="si">{</span><span class="n">siglen</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">siglen</span> <span class="ow">in</span> <span class="n">_critical_points</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_critical_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">siglen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;siglen (=</span><span class="si">{</span><span class="n">siglen</span><span class="si">}</span><span class="s2">) appended to _critical_points, len(_critical_points): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ==&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">onset_score_mask</span><span class="p">,</span> <span class="n">offset_score_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">siglen</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">siglen</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bias</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mask_onset</span><span class="p">,</span> <span class="n">mask_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">siglen</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">siglen</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="n">_af_intervals</span><span class="p">:</span>
            <span class="n">onset_start</span> <span class="o">=</span> <span class="n">_critical_points</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">)]</span>
            <span class="c1"># note that the onsets and offsets in `_af_intervals` already occupy positions in `_critical_points`</span>
            <span class="n">onset_end</span> <span class="o">=</span> <span class="n">_critical_points</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;custom --- onset (c_ind, score </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;custom --- onset (sample, score </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">_critical_points</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">)]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">_critical_points</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">mask_onset</span><span class="p">[</span><span class="n">onset_start</span><span class="p">:</span><span class="n">onset_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="c1"># note that the onsets and offsets in `af_intervals` already occupy positions in `_critical_points`</span>
            <span class="n">offset_start</span> <span class="o">=</span> <span class="n">_critical_points</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">b</span><span class="p">)]</span>
            <span class="n">offset_end</span> <span class="o">=</span> <span class="n">_critical_points</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;custom --- offset (c_ind, score </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;custom --- offset (sample, score </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">_critical_points</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)]</span><span class="si">}</span><span class="s2"> --- </span><span class="si">{</span><span class="n">_critical_points</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">_critical_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">mask_offset</span><span class="p">[</span><span class="n">offset_start</span><span class="p">:</span><span class="n">offset_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">onset_score_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">onset_score_mask</span><span class="p">,</span> <span class="n">mask_onset</span><span class="p">)</span>
        <span class="n">offset_score_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">offset_score_mask</span><span class="p">,</span> <span class="n">mask_offset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">onset_score_mask</span><span class="p">,</span> <span class="n">offset_score_mask</span>


<span class="c1"># aliases</span>
<span class="n">gen_endpoint_score_range</span> <span class="o">=</span> <span class="n">gen_endpoint_score_mask</span>
<span class="n">compute_metrics</span> <span class="o">=</span> <span class="n">compute_challenge_metric</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2021, WEN Hao, KANG Jingsu.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>