
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch_ecg.databases.physionet_databases.cinc2020 &#8212; torch-ecg 0.0.31 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=97348ffd" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=97348ffd" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../_static/documentation_options.js?v=c5dbc6bb"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/torch_ecg/databases/physionet_databases/cinc2020';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.0.31" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/deep-psp-logo.png" class="logo__image only-light" alt=""/>
    <img src="../../../../_static/deep-psp-logo.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">torch-ecg</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tutorial.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../examples.html">
    Examples
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DeepPSP/torch_ecg" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tutorial.html">
    Tutorial
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../examples.html">
    Examples
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DeepPSP/torch_ecg" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch_ecg.databases.physionet_databases.cinc2020</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for torch_ecg.databases.physionet_databases.cinc2020</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">posixpath</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Real</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">SS</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wfdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">loadmat</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">...cfg</span><span class="w"> </span><span class="kn">import</span> <span class="n">CFG</span><span class="p">,</span> <span class="n">DEFAULTS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">EAK</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.download</span><span class="w"> </span><span class="kn">import</span> <span class="n">_stem</span><span class="p">,</span> <span class="n">http_get</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_docstring</span><span class="p">,</span> <span class="n">get_record_list_recursive3</span><span class="p">,</span> <span class="n">list_sum</span><span class="p">,</span> <span class="n">ms2samples</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...utils.utils_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ensure_siglen</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..aux_data.cinc2020_aux_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">df_weights_abbr</span><span class="p">,</span> <span class="n">dx_mapping_all</span><span class="p">,</span> <span class="n">dx_mapping_scored</span><span class="p">,</span> <span class="n">equiv_class_dict</span><span class="p">,</span> <span class="n">load_weights</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_FIG_SIZE_PER_SEC</span><span class="p">,</span> <span class="n">DataBaseInfo</span><span class="p">,</span> <span class="n">PhysioNetDataBase</span><span class="p">,</span> <span class="n">_PlotCfg</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CINC2020&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_metrics&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_all_metrics&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_CINC2020_INFO</span> <span class="o">=</span> <span class="n">DataBaseInfo</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Classification of 12-lead ECGs: the PhysioNet/Computing in Cardiology Challenge 2020</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">about</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    0. There are 6 difference tranches of training data, listed as follows:</span>

<span class="s2">        A. 6,877 recordings from China Physiological Signal Challenge in 2018 (CPSC2018, see also [3]_): PhysioNetChallenge2020_Training_CPSC.tar.gz</span>
<span class="s2">        B. 3,453 recordings from China 12-Lead ECG Challenge Database (unused data from CPSC2018 and NOT the CPSC2018 test data): PhysioNetChallenge2020_Training_2.tar.gz</span>
<span class="s2">        C. 74 recordings from the St Petersburg INCART 12-lead Arrhythmia Database: PhysioNetChallenge2020_Training_StPetersburg.tar.gz</span>
<span class="s2">        D. 516 recordings from the PTB Diagnostic ECG Database: PhysioNetChallenge2020_Training_PTB.tar.gz</span>
<span class="s2">        E. 21,837 recordings from the PTB-XL electrocardiography Database: PhysioNetChallenge2020_PTB-XL.tar.gz</span>
<span class="s2">        F. 10,344 recordings from a Georgia 12-Lead ECG Challenge Database: PhysioNetChallenge2020_Training_E.tar.gz</span>

<span class="s2">       In total, 43,101 labeled recordings of 12-lead ECGs from four countries (China, Germany, Russia, and the USA) across 3 continents have been posted publicly for this Challenge, with approximately the same number hidden for testing, representing the largest public collection of 12-lead ECGs. All files can be downloaded from [7]_ or [8]_.</span>

<span class="s2">    1. the A tranche training data comes from CPSC2018, whose folder name is `Training_WFDB`. The B tranche training data are unused training data of CPSC2018, having folder name `Training_2`. For these 2 tranches, ref. the docstring of `database_reader.cpsc_databases.cpsc2018.CPSC2018`</span>
<span class="s2">    2. C, D, E tranches of training data all come from corresponding PhysioNet dataset, whose details can be found in corresponding files:</span>

<span class="s2">        - C: INCARTDB, ref [4]_</span>
<span class="s2">        - D: PTBDB, ref [5]_</span>
<span class="s2">        - E: PTB_XL, ref [6]_</span>

<span class="s2">       the C tranche has folder name `Training_StPetersburg`, the D tranche has folder name `Training_PTB`, the F tranche has folder name `WFDB`</span>
<span class="s2">    3. the F tranche is entirely new, posted for this Challenge, and represents a unique demographic of the Southeastern United States. It has folder name `Training_E/WFDB`.</span>
<span class="s2">    4. only a part of diagnosis_abbr (diseases that appear in the labels of the 6 tranches of training data) are used in the scoring function (ref. `dx_mapping_scored_cinc2020`), while others are ignored (ref. `dx_mapping_unscored_cinc2020`). The scored diagnoses were chosen based on prevalence of the diagnoses in the training data, the severity of the diagnoses, and the ability to determine the diagnoses from ECG recordings. The ignored diagnosis_abbr can be put in a a &quot;non-class&quot; group.</span>
<span class="s2">    5. the (updated) scoring function has a scoring matrix with nonzero off-diagonal elements. This scoring function reflects the clinical reality that some misdiagnoses are more harmful than others and should be scored accordingly. Moreover, it reflects the fact that confusing some classes is much less harmful than confusing other classes.</span>

<span class="s2">    6. sampling frequencies:</span>

<span class="s2">        A. (CPSC2018): 500 Hz</span>
<span class="s2">        B. (CPSC2018-2): 500 Hz</span>
<span class="s2">        C. (INCART): 257 Hz</span>
<span class="s2">        D. (PTB): 1000 Hz</span>
<span class="s2">        E. (PTB-XL): 500 Hz</span>
<span class="s2">        F. (Georgia): 500 Hz</span>

<span class="s2">    7. all data are recorded in the leads ordering of</span>

<span class="s2">       .. code-block:: python</span>

<span class="s2">            [&quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;aVR&quot;, &quot;aVL&quot;, &quot;aVF&quot;, &quot;V1&quot;, &quot;V2&quot;, &quot;V3&quot;, &quot;V4&quot;, &quot;V5&quot;, &quot;V6&quot;]</span>

<span class="s2">       using for example the following code:</span>

<span class="s2">         .. code-block:: python</span>

<span class="s2">            &gt;&gt;&gt; db_dir = &quot;/media/cfs/wenhao71/data/cinc2020_data/&quot;</span>
<span class="s2">            &gt;&gt;&gt; working_dir = &quot;./working_dir&quot;</span>
<span class="s2">            &gt;&gt;&gt; dr = CINC2020Reader(db_dir=db_dir,working_dir=working_dir)</span>
<span class="s2">            &gt;&gt;&gt; set_leads = []</span>
<span class="s2">            &gt;&gt;&gt; for tranche, l_rec in dr.all_records.items():</span>
<span class="s2">            ...     for rec in l_rec:</span>
<span class="s2">            ...         ann = dr.load_ann(rec)</span>
<span class="s2">            ...         leads = ann[&quot;df_leads&quot;][&quot;lead_name&quot;].values.tolist()</span>
<span class="s2">            ...     if leads not in set_leads:</span>
<span class="s2">            ...         set_leads.append(leads)</span>

<span class="s2">    8. Challenge official website [1]_. Webpage of the database on PhysioNet [2]_.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    1. The datasets have been roughly processed to have a uniform format, hence differ from their original resource (e.g. differe in sampling frequency, sample duration, etc.)</span>
<span class="s2">    2. The original datasets might have richer metadata (especially those from PhysioNet), which can be fetched from corresponding reader&#39;s docstring or website of the original source</span>
<span class="s2">    3. Each sub-dataset might have its own organizing scheme of data, which should be carefully dealt with</span>
<span class="s2">    4. There are few &quot;absolute&quot; diagnoses in 12 lead ECGs, where large discrepancies in the interpretation of the ECG can be found even inspected by experts. There is inevitably something lost in translation, especially when you do not have the context. This doesn&quot;t mean making an algorithm isn&#39;t important</span>
<span class="s2">    5. The labels are noisy, which one has to deal with in all real world data</span>
<span class="s2">    6. each line of the following classes are considered the same (in the scoring matrix):</span>

<span class="s2">        - RBBB, CRBBB (NOT including IRBBB)</span>
<span class="s2">        - PAC, SVPB</span>
<span class="s2">        - PVC, VPB</span>

<span class="s2">    7. unfortunately, the newly added tranches (C - F) have baseline drift and are much noisier. In contrast, CPSC data have had baseline removed and have higher SNR</span>
<span class="s2">    8. on Aug. 1, 2020, adc gain (including &quot;resolution&quot;, &quot;ADC&quot;? in .hea files) of datasets INCART, PTB, and PTB-xl (tranches C, D, E) are corrected. After correction, (the .tar files of) the 3 datasets are all put in a &quot;WFDB&quot; subfolder. In order to keep the structures consistant, they are moved into &quot;Training_StPetersburg&quot;, &quot;Training_PTB&quot;, &quot;WFDB&quot; as previously. Using the following code, one can check the adc_gain and baselines of each tranche:</span>

<span class="s2">       .. code-block:: python</span>

<span class="s2">            &gt;&gt;&gt; db_dir = &quot;/media/cfs/wenhao71/data/cinc2020_data/&quot;</span>
<span class="s2">            &gt;&gt;&gt; working_dir = &quot;./working_dir&quot;</span>
<span class="s2">            &gt;&gt;&gt; dr = CINC2020(db_dir=db_dir,working_dir=working_dir)</span>
<span class="s2">            &gt;&gt;&gt; resolution = {tranche: set() for tranche in &quot;ABCDEF&quot;}</span>
<span class="s2">            &gt;&gt;&gt; baseline = {tranche: set() for tranche in &quot;ABCDEF&quot;}</span>
<span class="s2">            &gt;&gt;&gt; for tranche, l_rec in dr.all_records.items():</span>
<span class="s2">            ...     for rec in l_rec:</span>
<span class="s2">            ...         ann = dr.load_ann(rec)</span>
<span class="s2">            ...         resolution[tranche] = resolution[tranche].union(set(ann[&quot;df_leads&quot;][&quot;adc_gain&quot;]))</span>
<span class="s2">            ...         baseline[tranche] = baseline[tranche].union(set(ann[&quot;df_leads&quot;][&quot;baseline&quot;]))</span>
<span class="s2">            &gt;&gt;&gt; print(resolution, baseline)</span>
<span class="s2">            {&quot;A&quot;: </span><span class="si">{1000.0}</span><span class="s2">, &quot;B&quot;: </span><span class="si">{1000.0}</span><span class="s2">, &quot;C&quot;: </span><span class="si">{1000.0}</span><span class="s2">, &quot;D&quot;: </span><span class="si">{1000.0}</span><span class="s2">, &quot;E&quot;: </span><span class="si">{1000.0}</span><span class="s2">, &quot;F&quot;: </span><span class="si">{1000.0}</span><span class="s2">} {&quot;A&quot;: </span><span class="si">{0}</span><span class="s2">, &quot;B&quot;: </span><span class="si">{0}</span><span class="s2">, &quot;C&quot;: </span><span class="si">{0}</span><span class="s2">, &quot;D&quot;: </span><span class="si">{0}</span><span class="s2">, &quot;E&quot;: </span><span class="si">{0}</span><span class="s2">, &quot;F&quot;: </span><span class="si">{0}</span><span class="s2">}</span>

<span class="s2">    9. the .mat files all contain digital signals, which has to be converted to physical values using adc gain, basesline, etc. in corresponding .hea files. :func:`wfdb.rdrecord` has already done this conversion, hence greatly simplifies the data loading process. NOTE that there&quot;s a difference when using `wfdb.rdrecord`: data from `loadmat` are in &quot;channel_first&quot; format, while `wfdb.rdrecord.p_signal` produces data in the &quot;channel_last&quot; format</span>
<span class="s2">    10. there are 3 equivalent (2 classes are equivalent if the corr. value in the scoring matrix is 1): (RBBB, CRBBB), (PAC, SVPB), (PVC, VPB)</span>
<span class="s2">    11. in the newly (Feb., 2021) created dataset, header files of each subset were gathered into one separate compressed file. This is due to the fact that updates on the dataset are almost always done in the header files. The correct usage of ref. [8]_, after uncompressing, is replacing the header files in the folder `All_training_WFDB` by header files from the 6 folders containing all header files from the 6 subsets.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">usage</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ECG arrhythmia detection&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">issues</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    1. reading the .hea files, baselines of all records are 0, however it is not the case if one plot the signal</span>
<span class="s2">    2. about half of the LAD records satisfy the &quot;2-lead&quot; criteria, but fail for the &quot;3-lead&quot; criteria, which means that their axis is (-30°, 0°) which is not truely LAD</span>
<span class="s2">    3. (Aug. 15, 2020; resolved, and changed to 1000) tranche F, the Georgia subset, has ADC gain 4880 which might be too high. Thus obtained voltages are too low. 1000 might be a suitable (correct) value of ADC gain for this tranche just as the other tranches.</span>
<span class="s2">    4. &quot;E04603&quot; (all leads), &quot;E06072&quot; (chest leads, epecially V1-V3), &quot;E06909&quot; (lead V2), &quot;E07675&quot; (lead V3), &quot;E07941&quot; (lead V6), &quot;E08321&quot; (lead V6) has exceptionally large values at rpeaks, reading (`load_data`) these two records using `wfdb` would bring in `nan` values. One can check using the following code</span>

<span class="s2">       .. code-block:: python</span>

<span class="s2">            &gt;&gt;&gt; rec = &quot;E04603&quot;</span>
<span class="s2">            &gt;&gt;&gt; dr.plot(rec, dr.load_data(rec, backend=&quot;scipy&quot;, units=&quot;uv&quot;))  # currently raising error</span>

<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">references</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;https://moody-challenge.physionet.org/2020/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://physionet.org/content/challenge-2020/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://2018.icbeb.org/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://physionet.org/content/incartdb/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://physionet.org/content/ptbdb/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://physionet.org/content/ptb-xl/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(deprecated) https://storage.cloud.google.com/physionet-challenge-2020-12-lead-ECG-public/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(recommended) https://storage.cloud.google.com/physionetchallenge2021-public-datasets/&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">doi</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;10.1088/1361-6579/abc960&quot;</span><span class="p">,</span>
        <span class="s2">&quot;10.22489/cinc.2020.236&quot;</span><span class="p">,</span>
        <span class="s2">&quot;10.13026/F4AB-0814&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>


<div class="viewcode-block" id="CINC2020">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020">[docs]</a>
<span class="nd">@add_docstring</span><span class="p">(</span><span class="n">_CINC2020_INFO</span><span class="o">.</span><span class="n">format_database_docstring</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;prepend&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CINC2020</span><span class="p">(</span><span class="n">PhysioNetDataBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db_dir : `path-like`, optional</span>
<span class="sd">        Storage path of the database.</span>
<span class="sd">        If not specified, data will be fetched from Physionet.</span>
<span class="sd">    working_dir : `path-like`, optional</span>
<span class="sd">        Working directory, to store intermediate files and log files.</span>
<span class="sd">    verbose : int, default 1</span>
<span class="sd">        Level of logging verbosity.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        Auxilliary key word arguments.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">db_name</span><span class="o">=</span><span class="s2">&quot;challenge-2020&quot;</span><span class="p">,</span>
            <span class="n">db_dir</span><span class="o">=</span><span class="n">db_dir</span><span class="p">,</span>
            <span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span> <span class="o">=</span> <span class="s2">&quot;mat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span> <span class="o">=</span> <span class="s2">&quot;hea&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;ABCDEF&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;CPSC&quot;</span><span class="p">,</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;CPSC-Extra&quot;</span><span class="p">,</span>
                <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;StPetersburg&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;PTB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;PTB-XL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;Georgia&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_prefix</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span>
                <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;HR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">257</span><span class="p">,</span>
            <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_leads</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">EAK</span><span class="o">.</span><span class="n">Standard12Leads</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_ecg_arrhythmia</span> <span class="o">=</span> <span class="n">dx_mapping_all</span><span class="p">[[</span><span class="s2">&quot;Dx&quot;</span><span class="p">,</span> <span class="s2">&quot;SNOMED CT Code&quot;</span><span class="p">,</span> <span class="s2">&quot;Abbreviation&quot;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;rec_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nb_leads&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nb_samples&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diagnosis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;df_leads&quot;</span><span class="p">,</span>
            <span class="s2">&quot;medical_prescription&quot;</span><span class="p">,</span>
            <span class="s2">&quot;history&quot;</span><span class="p">,</span>
            <span class="s2">&quot;symptom_or_surgery&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_trans_dict</span> <span class="o">=</span> <span class="n">equiv_class_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># self.value_correction_factor = CFG({tranche:1 for tranche in self.db_tranches})</span>
        <span class="c1"># self.value_correction_factor.F = 4.88  # ref. ISSUES 3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exceptional_records</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;E04603&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E06072&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E06909&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E07675&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E07941&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E08321&quot;</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># ref. ISSUES 4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_dir_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ls_rec</span><span class="p">()</span>  <span class="c1"># loads file system structures into `self._all_records`</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ls_diagnoses_records</span><span class="p">()</span>

<div class="viewcode-block" id="CINC2020.get_subject_id">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_subject_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_subject_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach a unique subject ID for the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Subject ID associated with the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">s2d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;31&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;32&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;41&quot;</span><span class="p">}</span>
        <span class="n">s2d</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_prefix</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s2d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[A-Z]&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s2d</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="si">}{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sid</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ls_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all records in the database directory</span>
<span class="sd">        and store them (path, metadata, etc.) in some private attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s2">-record_list.json&quot;</span>
        <span class="n">record_list_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="n">write_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">({</span><span class="n">tranche</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">record_list_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">record_list_fp</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">:</span>
                <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">tranche</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                <span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;tranche&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tranche</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">,</span> <span class="n">df_tmp</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">())</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Please wait patiently to let the reader find all records of all the tranches...&quot;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">rec_patterns_with_ext</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tranche</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_prefix</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span><span class="si">}</span><span class="s2">(?:</span><span class="se">\\</span><span class="s2">d+)</span><span class="se">\\</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">get_record_list_recursive3</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span><span class="p">),</span> <span class="n">rec_patterns_with_ext</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">to_save</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">:</span>
                <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">tranche</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                <span class="n">df_tmp</span><span class="p">[</span><span class="s2">&quot;tranche&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tranche</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">,</span> <span class="n">df_tmp</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;record&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> seconds!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">original_len</span><span class="p">:</span>
                <span class="n">write_file</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">write_file</span><span class="p">:</span>
                <span class="n">record_list_fp</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">to_save</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">tranche</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">df_tmp</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">tranche</span> <span class="o">==</span> <span class="n">tranche</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                                <span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">SEED</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
                            <span class="p">),</span>
                        <span class="p">],</span>
                        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">),</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">)))),</span>
                <span class="p">)</span>
                <span class="n">df_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">SEED</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">df_tmp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">tranche</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">tranche</span> <span class="o">==</span> <span class="n">tranche</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
            <span class="p">{</span><span class="n">tranche</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="p">[</span><span class="n">tranche</span><span class="p">]])</span> <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_tranches</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span> <span class="o">=</span> <span class="n">list_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">tranche</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># TODO: perhaps we can load labels and metadata of all records into `self._df_records` here</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ls_diagnoses_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all the records for all diagnoses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_reload : bool, default False</span>
<span class="sd">            Whether to force reload the list of records</span>
<span class="sd">            for each diagnosis or not.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s2">-diagnoses_records_list.json&quot;</span>
        <span class="n">dr_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span> <span class="o">/</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">dr_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dr_fp</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Please wait several minutes patiently to let the reader list records for each diagnosis...&quot;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df_weights_abbr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">tranche</span><span class="p">,</span> <span class="n">l_rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">l_rec</span><span class="p">:</span>
                    <span class="n">ann</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
                    <span class="n">ld</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s2">&quot;diagnosis_scored&quot;</span><span class="p">][</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> seconds!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dr_fp</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diagnoses_records_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ls_diagnoses_records</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnoses_records_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tranche</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tranche&quot;s symbol of a record via its name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tranche : str</span>
<span class="sd">            Symbol of the tranche, ref. `self.rec_prefix`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;tranche&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tranche</span>

<div class="viewcode-block" id="CINC2020.get_absolute_path">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_absolute_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">extension</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the absolute path of the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        extension : str, optional</span>
<span class="sd">            Extension of the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        abs_fp : pathlib.Path</span>
<span class="sd">            Absolute path of the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">abs_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_records</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">extension</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">abs_fp</span> <span class="o">=</span> <span class="n">abs_fp</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">abs_fp</span></div>


<div class="viewcode-block" id="CINC2020.get_data_filepath">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_data_filepath">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">with_ext</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the absolute file path of the data fileof the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        with_ext : bool, default True</span>
<span class="sd">            If True, the returned file path comes with file extension,</span>
<span class="sd">            otherwise without file extension.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pathlib.Path</span>
<span class="sd">            Absolute file path of the data file of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_ext</span> <span class="k">if</span> <span class="n">with_ext</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="CINC2020.get_header_filepath">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_header_filepath">[docs]</a>
    <span class="nd">@add_docstring</span><span class="p">(</span><span class="n">get_data_filepath</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;data file&quot;</span><span class="p">,</span> <span class="s2">&quot;header file&quot;</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">with_ext</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_ext</span> <span class="k">if</span> <span class="n">with_ext</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="CINC2020.get_ann_filepath">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_ann_filepath">[docs]</a>
    <span class="nd">@add_docstring</span><span class="p">(</span><span class="n">get_data_filepath</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;data file&quot;</span><span class="p">,</span> <span class="s2">&quot;annotation file&quot;</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ann_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">with_ext</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alias for `get_header_filepath`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_header_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="n">with_ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="CINC2020.load_data">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">leads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;channel_first&quot;</span><span class="p">,</span> <span class="s2">&quot;lead_first&quot;</span><span class="p">,</span> <span class="s2">&quot;channel_last&quot;</span><span class="p">,</span> <span class="s2">&quot;lead_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;channel_first&quot;</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;wfdb&quot;</span><span class="p">,</span> <span class="s2">&quot;scipy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mV&quot;</span><span class="p">,</span> <span class="s2">&quot;μV&quot;</span><span class="p">,</span> <span class="s2">&quot;uV&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mV&quot;</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Real</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_fs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Real</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load physical (converted from digital) ECG data,</span>
<span class="sd">        which is more understandable for humans;</span>
<span class="sd">        or load digital signal directly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        leads : str or int or List[str] or List[int], optional</span>
<span class="sd">            The leads of the ECG data to be loaded.</span>
<span class="sd">        data_format : str, default &quot;channel_first&quot;</span>
<span class="sd">            Format of the ECG data,</span>
<span class="sd">            &quot;channel_last&quot; (alias &quot;lead_last&quot;), or</span>
<span class="sd">            &quot;channel_first&quot; (alias &quot;lead_first&quot;).</span>
<span class="sd">        backend : {&quot;wfdb&quot;, &quot;scipy&quot;}, default &quot;wfdb&quot;</span>
<span class="sd">            The backend data reader.</span>
<span class="sd">        units : str or None, default &quot;mV&quot;</span>
<span class="sd">            Units of the output signal, can also be &quot;μV&quot; (aliases &quot;uV&quot;, &quot;muV&quot;).</span>
<span class="sd">            None for digital data, without digital-to-physical conversion.</span>
<span class="sd">        fs : numbers.Real, optional</span>
<span class="sd">            Sampling frequency of the output signal.</span>
<span class="sd">            If not None, the loaded data will be resampled to this frequency,</span>
<span class="sd">            otherwise, the original sampling frequency will be used.</span>
<span class="sd">        return_fs : bool, default False</span>
<span class="sd">            Whether to return the sampling frequency of the output signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : numpy.ndarray</span>
<span class="sd">            The ECG data of the record.</span>
<span class="sd">        data_fs : numbers.Real, optional</span>
<span class="sd">            Sampling frequency of the output signal.</span>
<span class="sd">            Returned if `return_fs` is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">data_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;channel_first&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lead_first&quot;</span><span class="p">,</span>
            <span class="s2">&quot;channel_last&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lead_last&quot;</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Invalid data_format: `</span><span class="si">{</span><span class="n">data_format</span><span class="si">}</span><span class="s2">`&quot;</span>

        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

        <span class="n">_leads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_leads</span><span class="p">(</span><span class="n">leads</span><span class="p">,</span> <span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">:</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># p_signal or d_signal of &quot;lead_last&quot; format</span>
            <span class="n">wfdb_rec</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdrecord</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">),</span>
                <span class="n">physical</span><span class="o">=</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">channel_names</span><span class="o">=</span><span class="n">_leads</span><span class="p">,</span>
                <span class="n">return_res</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">wfdb_rec</span><span class="o">.</span><span class="n">d_signal</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">wfdb_rec</span><span class="o">.</span><span class="n">p_signal</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># lead_units = np.vectorize(lambda s: s.lower())(wfdb_rec.units)</span>
        <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scipy&quot;</span><span class="p">:</span>
            <span class="c1"># loadmat of &quot;lead_first&quot; format</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">))[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;df_leads&quot;</span><span class="p">]</span>
                <span class="n">baselines</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">adc_gain</span> <span class="o">=</span> <span class="n">header_info</span><span class="p">[</span><span class="s2">&quot;adc_gain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">baselines</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span> <span class="o">/</span> <span class="n">adc_gain</span>
            <span class="n">leads_ind</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_leads</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_leads</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">leads_ind</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># lead_units = np.vectorize(lambda s: s.lower())(header_info[&quot;df_leads&quot;][&quot;adc_units&quot;].values)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;backend `</span><span class="si">{</span><span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">` not supported for loading data&quot;</span><span class="p">)</span>

        <span class="c1"># ref. ISSUES 3, for multiplying `value_correction_factor`</span>
        <span class="c1"># data = data * self.value_correction_factor[tranche]</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;uv&quot;</span><span class="p">,</span> <span class="s2">&quot;μv&quot;</span><span class="p">,</span> <span class="s2">&quot;muv&quot;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">SS</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">data_fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;channel_last&quot;</span><span class="p">,</span> <span class="s2">&quot;lead_last&quot;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">return_fs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_fs</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="CINC2020.load_ann">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.load_ann">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_ann</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load annotations of the record.</span>

<span class="sd">        The annotations are stored in the .hea files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        raw : bool, default False</span>
<span class="sd">            If True, the raw annotations without parsing will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ann_dict : dict or str</span>
<span class="sd">            The annotations with items listed in `self.ann_items`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="n">ann_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ann_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">header_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ann_fp</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">ann_dict</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ann_dict</span>

        <span class="n">ann_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_ann_wfdb</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">header_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ann_dict</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_ann_wfdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">header_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load annotations (header) using :func:`wfdb.rdheader`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        header_data : List[str]</span>
<span class="sd">            List of lines read directly from a header file.</span>
<span class="sd">            This data will be used, since `datetime` is</span>
<span class="sd">            not well parsed by :func:`wfdb.rdheader`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ann_dict : dict</span>
<span class="sd">            The annotations with items listed in `self.ann_items`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">header_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_header_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">header_reader</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">header_fp</span><span class="p">))</span>
        <span class="n">ann_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;rec_name&quot;</span><span class="p">],</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_leads&quot;</span><span class="p">],</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">],</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_samples&quot;</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="s2">&quot; &quot;</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">daytime</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">daytime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_leads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_leads&quot;</span><span class="p">])</span>
        <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">])</span>
        <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;nb_samples&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">daytime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">daytime</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%b-%Y %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># see NOTE. 1.</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Age&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Sex&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;medical_prescription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Rx&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;medical_prescription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Hx&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;symptom_or_surgery&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Sx&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;symptom_or_surgery&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="n">l_Dx</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_reader</span><span class="o">.</span><span class="n">comments</span> <span class="k">if</span> <span class="s2">&quot;Dx&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis&quot;</span><span class="p">],</span> <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_scored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_diagnosis</span><span class="p">(</span><span class="n">l_Dx</span><span class="p">)</span>

        <span class="n">df_leads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fmt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;byte_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_gain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_res&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_zero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;baseline&quot;</span><span class="p">,</span>
            <span class="s2">&quot;init_value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;checksum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;block_size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sig_name&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">df_leads</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_reader</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">df_leads</span> <span class="o">=</span> <span class="n">df_leads</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;sig_name&quot;</span><span class="p">:</span> <span class="s2">&quot;lead_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;adc_units&quot;</span><span class="p">,</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df_leads</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;lead_name&quot;</span><span class="p">]</span>
        <span class="n">df_leads</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;df_leads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span>

        <span class="k">return</span> <span class="n">ann_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_diagnosis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_Dx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse diagnosis from a list of strings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        l_Dx : List[str]</span>
<span class="sd">            Raw information of diagnosis, read from a header file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        diag_dict : dict</span>
<span class="sd">            Diagnosis, including SNOMED CT Codes,</span>
<span class="sd">            fullnames and abbreviations of each diagnosis.</span>
<span class="sd">        diag_scored_dict : dict</span>
<span class="sd">            The scored items in `diag_dict`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">diag_dict</span><span class="p">,</span> <span class="n">diag_scored_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">l_Dx</span><span class="p">]</span>
            <span class="c1"># selection = dx_mapping_all[&quot;SNOMED CT Code&quot;].isin(diag_dict[&quot;diagnosis_code&quot;])</span>
            <span class="c1"># diag_dict[&quot;diagnosis_abbr&quot;] = dx_mapping_all[selection][&quot;Abbreviation&quot;].tolist()</span>
            <span class="c1"># diag_dict[&quot;diagnosis_fullname&quot;] = dx_mapping_all[selection][&quot;Dx&quot;].tolist()</span>
            <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">dx_mapping_all</span><span class="p">[</span><span class="n">dx_mapping_all</span><span class="p">[</span><span class="s2">&quot;SNOMED CT Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dc</span><span class="p">][</span><span class="s2">&quot;Abbreviation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_fullname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">dx_mapping_all</span><span class="p">[</span><span class="n">dx_mapping_all</span><span class="p">[</span><span class="s2">&quot;SNOMED CT Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dc</span><span class="p">][</span><span class="s2">&quot;Dx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">scored_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">],</span> <span class="n">dx_mapping_scored</span><span class="p">[</span><span class="s2">&quot;SNOMED CT Code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">diag_scored_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">scored_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">diag_scored_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">scored_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">diag_scored_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_fullname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_fullname&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">scored_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># the old version, the Dx&quot;s are abbreviations</span>
            <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">dx_mapping_all</span><span class="p">[</span><span class="s2">&quot;Abbreviation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">])</span>
            <span class="n">diag_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_fullname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx_mapping_all</span><span class="p">[</span><span class="n">selection</span><span class="p">][</span><span class="s2">&quot;Dx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">diag_dict</span><span class="p">,</span> <span class="n">diag_scored_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_leads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_leads_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse leads information from a list of strings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        l_leads_data : List[str]</span>
<span class="sd">            Raw information of each lead, read from a header file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_leads : pandas.DataFrame</span>
<span class="sd">            Infomation of each leads in the format</span>
<span class="sd">            of a :class:`~pandas.DataFrame`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_leads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l_leads_data</span><span class="p">)),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">df_leads</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fmt+byte_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_gain+units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_res&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_zero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;init_value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;checksum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;block_size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lead_name&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;fmt+byte_offset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;byte_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;fmt+byte_offset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;adc_gain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;adc_gain+units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;adc_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;adc_gain+units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;byte_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_gain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_res&quot;</span><span class="p">,</span>
            <span class="s2">&quot;adc_zero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;init_value&quot;</span><span class="p">,</span>
            <span class="s2">&quot;checksum&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">df_leads</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;adc_zero&quot;</span><span class="p">]</span>
        <span class="n">df_leads</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fmt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;byte_offset&quot;</span><span class="p">,</span>
                <span class="s2">&quot;adc_gain&quot;</span><span class="p">,</span>
                <span class="s2">&quot;adc_units&quot;</span><span class="p">,</span>
                <span class="s2">&quot;adc_res&quot;</span><span class="p">,</span>
                <span class="s2">&quot;adc_zero&quot;</span><span class="p">,</span>
                <span class="s2">&quot;baseline&quot;</span><span class="p">,</span>
                <span class="s2">&quot;init_value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;checksum&quot;</span><span class="p">,</span>
                <span class="s2">&quot;block_size&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lead_name&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">df_leads</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_leads</span><span class="p">[</span><span class="s2">&quot;lead_name&quot;</span><span class="p">]</span>
        <span class="n">df_leads</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">df_leads</span>

<div class="viewcode-block" id="CINC2020.load_header">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.load_header">[docs]</a>
    <span class="nd">@add_docstring</span><span class="p">(</span><span class="n">load_ann</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        alias for `load_ann`, as annotations are also stored in header files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span></div>


<div class="viewcode-block" id="CINC2020.get_labels">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">scored_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get labels (diagnoses or arrhythmias) of the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        scored_only : bool, default True</span>
<span class="sd">            If True, only get the labels that are scored</span>
<span class="sd">            in the CINC2020 official phase.</span>
<span class="sd">        fmt : str, default &quot;s&quot;</span>
<span class="sd">            Format of labels, one of the following (case insensitive):</span>

<span class="sd">                - &quot;a&quot;, abbreviations</span>
<span class="sd">                - &quot;f&quot;, full names</span>
<span class="sd">                - &quot;s&quot;, SNOMED CT Code</span>

<span class="sd">        normalize : bool, default True</span>
<span class="sd">            If True, the labels will be transformed into their equavalents,</span>
<span class="sd">            which are defined in `utils.utils_misc.cinc2020_aux_data.py`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        labels : List[str]</span>
<span class="sd">            The list of labels of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ann_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scored_only</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis_scored&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">ann_dict</span><span class="p">[</span><span class="s2">&quot;diagnosis&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="s2">&quot;diagnosis_abbr&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="s2">&quot;diagnosis_fullname&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="s2">&quot;diagnosis_code&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`fmt` should be one of `a`, `f`, `s`, but got `</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_trans_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="CINC2020.get_fs">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_fs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Real</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the sampling frequency of the record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fs : numbers.Real</span>
<span class="sd">            Sampling frequency of the record.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fs</span></div>


<div class="viewcode-block" id="CINC2020.get_subject_info">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_subject_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_subject_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get auxiliary information of a subject</span>
<span class="sd">        (a record) stored in the header files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        items : List[str], optional</span>
<span class="sd">            Items of the subject&#39;s information (e.g. sex, age, etc.).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        subject_info : dict</span>
<span class="sd">            Information about the subject, including</span>
<span class="sd">            &quot;age&quot;, &quot;sex&quot;, &quot;medical_prescription&quot;,</span>
<span class="sd">            &quot;history&quot;, &quot;symptom_or_surgery&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info_items</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sex&quot;</span><span class="p">,</span>
                <span class="s2">&quot;medical_prescription&quot;</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="s2">&quot;symptom_or_surgery&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_items</span> <span class="o">=</span> <span class="n">items</span>
        <span class="n">ann_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ann</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="n">subject_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">ann_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info_items</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">subject_info</span></div>


<div class="viewcode-block" id="CINC2020.plot">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ann</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ticks_granularity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">leads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">same_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">waves</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the signals of a record or external signals (units in μV),</span>
<span class="sd">        with metadata (fs, labels, tranche, etc.),</span>
<span class="sd">        possibly also along with wave delineations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        data : numpy.ndarray, optional</span>
<span class="sd">            (12-lead) ECG signal to plot,</span>
<span class="sd">            should be of the format &quot;channel_first&quot;,</span>
<span class="sd">            and compatible with `leads`.</span>
<span class="sd">            If is not None, data of `rec` will not be used.</span>
<span class="sd">            This is useful when plotting filtered data.</span>
<span class="sd">        ann : dict, optional</span>
<span class="sd">            Annotations for `data`, with 2 items: &quot;scored&quot;, &quot;all&quot;.</span>
<span class="sd">            Ignored if `data` is None.</span>
<span class="sd">        ticks_granularity : int, default 0</span>
<span class="sd">            Granularity to plot axis ticks, the higher the more ticks.</span>
<span class="sd">            0 (no ticks) --&gt; 1 (major ticks) --&gt; 2 (major + minor ticks)</span>
<span class="sd">        leads : str or List[str], optional</span>
<span class="sd">            The leads of the ECG signal to plot.</span>
<span class="sd">        same_range : bool, default False</span>
<span class="sd">            If True, all leads are forced to have the same y range.</span>
<span class="sd">        waves : dict, optional</span>
<span class="sd">            Indices of the wave critical points, including</span>
<span class="sd">            &quot;p_onsets&quot;, &quot;p_peaks&quot;, &quot;p_offsets&quot;,</span>
<span class="sd">            &quot;q_onsets&quot;, &quot;q_peaks&quot;, &quot;r_peaks&quot;, &quot;s_peaks&quot;, &quot;s_offsets&quot;,</span>
<span class="sd">            &quot;t_onsets&quot;, &quot;t_peaks&quot;, &quot;t_offsets&quot;.</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Additional keyword arguments to pass to :func:`matplotlib.pyplot.plot`.</span>

<span class="sd">        TODO</span>
<span class="sd">        ----</span>
<span class="sd">        1. Slice too long records, and plot separately for each segment.</span>
<span class="sd">        2. Plot waves using :func:`matplotlib.pyplot.axvspan`.</span>

<span class="sd">        NOTE</span>
<span class="sd">        ----</span>
<span class="sd">        `Locator` of ``plt`` has default `MAXTICKS` of 1000.</span>
<span class="sd">        If not modifying this number, at most 40 seconds of signal could be plotted once.</span>

<span class="sd">        Contributors: Jeethan, and WEN Hao</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="s2">&quot;CDE&quot;</span><span class="p">:</span>
            <span class="n">physionet_lightwave_suffix</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;incartdb/1.0.0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;ptbdb/1.0.0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;ptb-xl/1.0.1&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://physionet.org/lightwave/?db=</span><span class="si">{</span><span class="n">physionet_lightwave_suffix</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;better view: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;plt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="o">.</span><span class="n">MAXTICKS</span> <span class="o">=</span> <span class="mi">3000</span>

        <span class="n">_leads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_leads</span><span class="p">(</span><span class="n">leads</span><span class="p">,</span> <span class="n">numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">lead_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_leads</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="k">for</span> <span class="n">ld</span> <span class="ow">in</span> <span class="n">_leads</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;channel_first&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;μV&quot;</span><span class="p">)[</span><span class="n">lead_indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_infer_units</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input data is auto detected to have units in </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mv&quot;</span><span class="p">:</span>
                <span class="n">_data</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">assert</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">_leads</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;number of leads from data of shape (</span><span class="si">{</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) does not match the length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_leads</span><span class="p">)</span><span class="si">}</span><span class="s2">) of `leads`&quot;</span>

        <span class="k">if</span> <span class="n">same_range</span><span class="p">:</span>
            <span class="n">y_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_data</span><span class="p">))</span> <span class="o">+</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">waves</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">p_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">))),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">p</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">p_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;p_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_waves</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;q_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;s_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">q_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">))),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">s</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">s_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;q_peaks&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;s_peaks&quot;</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;r_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">qrs_radius</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">))),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">r</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">qrs_radius</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;r_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_onsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_offsets&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[[</span><span class="n">onset</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_onsets&quot;</span><span class="p">],</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_offsets&quot;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">waves</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t_peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">t_onset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">))),</span>
                        <span class="nb">min</span><span class="p">(</span>
                            <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">t</span> <span class="o">+</span> <span class="n">ms2samples</span><span class="p">(</span><span class="n">_PlotCfg</span><span class="o">.</span><span class="n">t_offset</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fs</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">waves</span><span class="p">[</span><span class="s2">&quot;t_peaks&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_waves</span><span class="p">,</span> <span class="n">qrs</span><span class="p">,</span> <span class="n">t_waves</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;p_waves&quot;</span><span class="p">:</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;qrs&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_waves&quot;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">plot_alpha</span> <span class="o">=</span> <span class="mf">0.4</span>

        <span class="k">if</span> <span class="n">ann</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag_scored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">scored_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">diag_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">scored_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diag_scored</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s2">&quot;scored&quot;</span><span class="p">]</span>
            <span class="n">diag_all</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>

        <span class="n">nb_leads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_leads</span><span class="p">)</span>

        <span class="n">seg_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span>  <span class="c1"># 25 seconds</span>
        <span class="n">nb_segs</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">seg_len</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span>
        <span class="n">fig_sz_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DEFAULT_FIG_SIZE_PER_SEC</span> <span class="o">*</span> <span class="n">duration</span><span class="p">))</span>
        <span class="n">fig_sz_h</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y_ranges</span><span class="p">,</span> <span class="mi">750</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1500</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nb_leads</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_sz_w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fig_sz_h</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">nb_leads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_leads</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">_data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lead - </span><span class="si">{</span><span class="n">_leads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="c1"># NOTE that `Locator` has default `MAXTICKS` equal to 1000</span>
            <span class="k">if</span> <span class="n">ticks_granularity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;0.4&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ticks_granularity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.04</span><span class="p">))</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="s2">&quot;0.2&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
            <span class="c1"># add extra info. to legend</span>
            <span class="c1"># https://stackoverflow.com/questions/16826711/is-it-possible-to-add-a-string-as-a-legend-item-in-matplotlib</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;labels_s - </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diag_scored</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;labels_a - </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diag_all</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tranche - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;fs - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p_waves&quot;</span><span class="p">,</span> <span class="s2">&quot;qrs&quot;</span><span class="p">,</span> <span class="s2">&quot;t_waves&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">itv</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">itv</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">t</span><span class="p">[</span><span class="n">itv</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_alpha</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="mi">600</span><span class="p">,</span> <span class="o">-</span><span class="n">y_ranges</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="n">y_ranges</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Voltage [μV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;save_path&quot;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="CINC2020.get_tranche_class_distribution">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.get_tranche_class_distribution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tranche_class_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tranches</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">scored_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute class distribution in the tranches.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tranches : Sequence[str]</span>
<span class="sd">            Tranche symbols (A-F).</span>
<span class="sd">        scored_only : bool, default True</span>
<span class="sd">            If True, only classes that are scored in the CINC2020 official phase</span>
<span class="sd">            are considered for computing the distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        distribution : dict</span>
<span class="sd">            Distribution of classes in the tranches.</span>
<span class="sd">            Keys are abbrevations of the classes, and</span>
<span class="sd">            values are appearance of corr. classes in the tranche.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tranche_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tranches</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dx_mapping_scored</span> <span class="k">if</span> <span class="n">scored_only</span> <span class="k">else</span> <span class="n">dx_mapping_all</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">CFG</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">tranche_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">distribution</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Abbreviation&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num</span>
        <span class="k">return</span> <span class="n">distribution</span></div>


<div class="viewcode-block" id="CINC2020.load_resampled_data">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.load_resampled_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_resampled_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;channel_first&quot;</span><span class="p">,</span>
        <span class="n">siglen</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resample the data of `rec` to 500Hz,</span>
<span class="sd">        or load the resampled data in 500Hz, if the corr. data file already exists</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        data_format : str, default &quot;channel_first&quot;</span>
<span class="sd">            Format of the ECG data,</span>
<span class="sd">            &quot;channel_last&quot; (alias &quot;lead_last&quot;), or</span>
<span class="sd">            &quot;channel_first&quot; (alias &quot;lead_first&quot;).</span>
<span class="sd">        siglen : int, optional</span>
<span class="sd">            Signal length, with units in number of samples.</span>
<span class="sd">            If is not None, signal with length longer will be</span>
<span class="sd">            sliced to the length of `siglen`.</span>
<span class="sd">            Used for preparing/doing model training for example.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            2D resampled (and perhaps sliced 3D) signal data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">siglen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s2">-rsmp-500Hz&quot;</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">_500Hz.npy&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s2">-rsmp-500Hz&quot;</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tranche_names</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">_500Hz_siglen_</span><span class="si">{</span><span class="n">siglen</span><span class="si">}</span><span class="s2">.npy&quot;</span>
            <span class="p">)</span>
        <span class="n">rec_fp</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rec_fp</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># self.logger.info(f&quot;corresponding file {rec_fp.name} does not exist&quot;)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;channel_first&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;mV&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">SS</span><span class="o">.</span><span class="n">resample_poly</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">tranche</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">siglen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">siglen</span><span class="p">:</span>
                <span class="c1"># slice_start = (data.shape[1] - siglen)//2</span>
                <span class="c1"># slice_end = slice_start + siglen</span>
                <span class="c1"># data = data[..., slice_start:slice_end]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ensure_siglen</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">siglen</span><span class="o">=</span><span class="n">siglen</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;channel_first&quot;</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">siglen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.logger.info(f&quot;loading from local file...&quot;)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;channel_last&quot;</span><span class="p">,</span> <span class="s2">&quot;lead_last&quot;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="CINC2020.load_raw_data">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.load_raw_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;scipy&quot;</span><span class="p">,</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;scipy&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load raw data from corresponding files with no further processing,</span>
<span class="sd">        in order to facilitate feeding data into the `run_12ECG_classifier` function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : str or int</span>
<span class="sd">            Record name or index of the record in :attr:`all_records`.</span>
<span class="sd">        backend : {&quot;scipy&quot;, &quot;wfdb&quot;}, default &quot;scipy&quot;</span>
<span class="sd">            The backend data reader.</span>
<span class="sd">            Note that &quot;scipy&quot; provides data in the format of &quot;lead_first&quot;,</span>
<span class="sd">            while &quot;wfdb&quot; provides data in the format of &quot;lead_last&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        raw_data: numpy.ndarray</span>
<span class="sd">            Raw data (d_signal) loaded from corresponding data file,</span>
<span class="sd">            without digital-to-analog conversion (DAC) and resampling.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
        <span class="n">tranche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tranche</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;wfdb&quot;</span><span class="p">:</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">wfdb_rec</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdrecord</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">),</span> <span class="n">physical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfdb_rec</span><span class="o">.</span><span class="n">d_signal</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;scipy&quot;</span><span class="p">:</span>
            <span class="n">rec_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_filepath</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">with_ext</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rec_fp</span><span class="p">))[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">DTYPE</span><span class="o">.</span><span class="n">NP</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_data</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tranches</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if records from `tranches` has nan values.</span>

<span class="sd">        Accessing data using `p_signal` of `wfdb` would produce nan values,</span>
<span class="sd">        if exceptionally large values are encountered.</span>
<span class="sd">        This function could help detect abnormal records as well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tranches : str or Sequence[str]</span>
<span class="sd">            Tranches to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tranches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_records</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;record </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2"> from tranche </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> has nan values&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;https://storage.cloud.google.com/physionet-challenge-2020-12-lead-ECG-public/&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">]</span>

    <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_CPSC.tar.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_2.tar.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_StPetersburg.tar.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_PTB.tar.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_PTB-XL.tar.gz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhysioNetChallenge2020_Training_E.tar.gz&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="CINC2020.download">
<a class="viewcode-back" href="../../../../api/generated/torch_ecg.databases.CINC2020.html#torch_ecg.databases.CINC2020.download">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_dir</span> <span class="o">/</span> <span class="n">_stem</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ls_rec</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all_records</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">database_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataBaseInfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_CINC2020_INFO</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">compute_all_metrics</span><span class="p">(</span><span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">truth</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">binary_pred</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">scalar_pred</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute all the metrics for the challenge.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classes : List[str]</span>
<span class="sd">        List of all the classes, in the format of abbrevations.</span>
<span class="sd">    truth : array_like</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    binary_pred : array_like</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    scalar_pred : array_like</span>
<span class="sd">        Probability predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values within the interval [0, 1].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    auroc : float</span>
<span class="sd">        Area under the receiver operating characteristic (ROC) curve.</span>
<span class="sd">    auprc : float</span>
<span class="sd">        Area under the precision-recall curve.</span>
<span class="sd">    accuracy : float</span>
<span class="sd">        Macro-averaged accuracy.</span>
<span class="sd">    f_measure : float</span>
<span class="sd">        Macro-averaged F1 score.</span>
<span class="sd">    f_beta_measure : float</span>
<span class="sd">        Macro-averaged F-beta score.</span>
<span class="sd">    g_beta_measure : float</span>
<span class="sd">        Macro-averaged G-beta score.</span>
<span class="sd">    challenge_metric : float</span>
<span class="sd">        Challenge metric, defined by a weight matrix.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># normal_class = &quot;426783006&quot;</span>
    <span class="n">normal_class</span> <span class="o">=</span> <span class="s2">&quot;NSR&quot;</span>
    <span class="c1"># equivalent_classes = [[&quot;713427006&quot;, &quot;59118001&quot;], [&quot;284470004&quot;, &quot;63593006&quot;], [&quot;427172004&quot;, &quot;17338001&quot;]]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">load_weights</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>

    <span class="n">_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">truth</span><span class="p">)</span>
    <span class="n">_binary_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">binary_pred</span><span class="p">)</span>
    <span class="n">_scalar_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scalar_pred</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- AUROC and AUPRC...&quot;</span><span class="p">)</span>
    <span class="n">auroc</span><span class="p">,</span> <span class="n">auprc</span> <span class="o">=</span> <span class="n">_compute_auc</span><span class="p">(</span><span class="n">_truth</span><span class="p">,</span> <span class="n">_scalar_pred</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Accuracy...&quot;</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">_compute_accuracy</span><span class="p">(</span><span class="n">_truth</span><span class="p">,</span> <span class="n">_binary_pred</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- F-measure...&quot;</span><span class="p">)</span>
    <span class="n">f_measure</span> <span class="o">=</span> <span class="n">_compute_f_measure</span><span class="p">(</span><span class="n">_truth</span><span class="p">,</span> <span class="n">_binary_pred</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- F-beta and G-beta measures...&quot;</span><span class="p">)</span>
    <span class="n">f_beta_measure</span><span class="p">,</span> <span class="n">g_beta_measure</span> <span class="o">=</span> <span class="n">_compute_beta_measures</span><span class="p">(</span><span class="n">_truth</span><span class="p">,</span> <span class="n">_binary_pred</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Challenge metric...&quot;</span><span class="p">)</span>
    <span class="n">challenge_metric</span> <span class="o">=</span> <span class="n">compute_challenge_metric</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">_truth</span><span class="p">,</span> <span class="n">_binary_pred</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">normal_class</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>

    <span class="c1"># Return the results.</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">auroc</span><span class="p">,</span>
        <span class="n">auprc</span><span class="p">,</span>
        <span class="n">accuracy</span><span class="p">,</span>
        <span class="n">f_measure</span><span class="p">,</span>
        <span class="n">f_beta_measure</span><span class="p">,</span>
        <span class="n">g_beta_measure</span><span class="p">,</span>
        <span class="n">challenge_metric</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_accuracy</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute recording-wise accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    accuracy : float</span>
<span class="sd">        Macro-averaged accuracy.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">num_correct_recordings</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recordings</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]):</span>
            <span class="n">num_correct_recordings</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_correct_recordings</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_recordings</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_confusion_matrices</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute confusion matrices.</span>

<span class="sd">    Compute a binary confusion matrix for each class k:</span>

<span class="sd">          [TN_k FN_k]</span>
<span class="sd">          [FP_k TP_k]</span>

<span class="sd">    If the normalize variable is set to true, then normalize the contributions</span>
<span class="sd">    to the confusion matrix by the number of labels per recording.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    normalize : bool, optional</span>
<span class="sd">        If true, normalize the confusion matrices by the number of labels per</span>
<span class="sd">        recording. Default is false.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : numpy.ndarray</span>
<span class="sd">        Confusion matrices, of shape ``(n_classes, 2, 2)``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recordings</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TP</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># FP</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># FN</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># TN</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># This condition should not happen.</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error in computing the confusion matrix.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recordings</span><span class="p">):</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TP</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">normalization</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># FP</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">normalization</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># FN</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">normalization</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># TN</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">normalization</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># This condition should not happen.</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error in computing the confusion matrix.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_f_measure</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute macro-averaged F1 score.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f_measure : float</span>
<span class="sd">        Macro-averaged F1 score.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">_compute_confusion_matrices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

    <span class="n">f_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">f_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="n">macro_f_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">f_measure</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">macro_f_measure</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_beta_measures</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute F-beta and G-beta measures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    beta : float</span>
<span class="sd">        Beta parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f_beta_measure : float</span>
<span class="sd">        Macro-averaged F-beta measure.</span>
<span class="sd">    g_beta_measure : float</span>
<span class="sd">        Macro-averaged G-beta measure.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">_compute_confusion_matrices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">f_beta_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">g_beta_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">f_beta_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_beta_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">g_beta_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_beta_measure</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="n">macro_f_beta_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">f_beta_measure</span><span class="p">)</span>
    <span class="n">macro_g_beta_measure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">g_beta_measure</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">macro_f_beta_measure</span><span class="p">,</span> <span class="n">macro_g_beta_measure</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_auc</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute macro-averaged AUROC and macro-averaged AUPRC.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    auroc : float</span>
<span class="sd">        Macro-averaged AUROC.</span>
<span class="sd">    auprc : float</span>
<span class="sd">        Macro-averaged AUPRC.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># Compute and summarize the confusion matrices for each class across at distinct output values.</span>
    <span class="n">auroc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">auprc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="c1"># We only need to compute TPs, FPs, FNs, and TNs at distinct output values.</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">outputs</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">num_thresholds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span>

        <span class="c1"># Initialize the TPs, FPs, FNs, and TNs.</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Find the indices that result in sorted output values.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">outputs</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Compute the TPs, FPs, FNs, and TNs for class k across thresholds.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_thresholds</span><span class="p">):</span>
            <span class="c1"># Initialize TPs, FPs, FNs, and TNs using values at previous threshold.</span>
            <span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">tn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Update the TPs, FPs, FNs, and TNs at i-th output value.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_recordings</span> <span class="ow">and</span> <span class="n">outputs</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">]:</span>
                    <span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">tn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Summarize the TPs, FPs, FNs, and TNs for class k.</span>
        <span class="n">tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">tnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="n">ppv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_thresholds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">tpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">tn</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">tnr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tn</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">tn</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">ppv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ppv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="c1"># Compute AUROC as the area under a piecewise linear function with TPR/</span>
        <span class="c1"># sensitivity (x-axis) and TNR/specificity (y-axis) and AUPRC as the area</span>
        <span class="c1"># under a piecewise constant with TPR/recall (x-axis) and PPV/precision</span>
        <span class="c1"># (y-axis) for class k.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_thresholds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">auroc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tpr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tpr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">tnr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tnr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">auprc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tpr</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tpr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">ppv</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Compute macro AUROC and macro AUPRC across classes.</span>
    <span class="n">macro_auroc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">auroc</span><span class="p">)</span>
    <span class="n">macro_auprc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">auprc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">macro_auroc</span><span class="p">,</span> <span class="n">macro_auprc</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_modified_confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a binary multi-class, multi-label confusion matrix,</span>
<span class="sd">    where the rows are the labels and the columns are the outputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : numpy.ndarray</span>
<span class="sd">        Modified confusion matrix, of shape ``(n_classes, n_classes)``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>

    <span class="c1"># Iterate over all of the recordings.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recordings</span><span class="p">):</span>
        <span class="c1"># Calculate the number of positive labels and/or outputs.</span>
        <span class="n">normalization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Iterate over all of the classes.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="c1"># Assign full and/or partial credit for each positive class.</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]:</span>
                        <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">normalization</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_challenge_metric</span><span class="p">(</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">normal_class</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the evaluation metrics for the Challenge.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights : numpy.ndarray</span>
<span class="sd">        Array of weights, of shape ``(n_classes, n_classes)``.</span>
<span class="sd">    labels : numpy.ndarray</span>
<span class="sd">        Ground truth array, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    outputs : numpy.ndarray</span>
<span class="sd">        Binary predictions, of shape ``(n_records, n_classes)``,</span>
<span class="sd">        with values 0 or 1.</span>
<span class="sd">    classes : List[str]</span>
<span class="sd">        List of class names.</span>
<span class="sd">    normal_class : str</span>
<span class="sd">        Name of the normal class.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    score : float</span>
<span class="sd">        Challenge metric score.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">normal_index</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">normal_class</span><span class="p">)</span>

    <span class="c1"># Compute the observed score.</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">_compute_modified_confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="n">observed_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

    <span class="c1"># Compute the score for the model that always chooses the correct label(s).</span>
    <span class="n">correct_outputs</span> <span class="o">=</span> <span class="n">labels</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">_compute_modified_confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">correct_outputs</span><span class="p">)</span>
    <span class="n">correct_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

    <span class="c1"># Compute the score for the model that always chooses the normal class.</span>
    <span class="n">inactive_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_recordings</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">inactive_outputs</span><span class="p">[:,</span> <span class="n">normal_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">_compute_modified_confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">inactive_outputs</span><span class="p">)</span>
    <span class="n">inactive_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">correct_score</span> <span class="o">!=</span> <span class="n">inactive_score</span><span class="p">:</span>
        <span class="n">normalized_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">observed_score</span> <span class="o">-</span> <span class="n">inactive_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">correct_score</span> <span class="o">-</span> <span class="n">inactive_score</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">normalized_score</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">normalized_score</span>


<span class="c1"># alias</span>
<span class="n">compute_metrics</span> <span class="o">=</span> <span class="n">compute_challenge_metric</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2021, WEN Hao, KANG Jingsu.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>